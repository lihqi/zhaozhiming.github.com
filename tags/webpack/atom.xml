<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: webpack | Hacker and Geeker's Way]]></title>
  <link href="http://zhaozhiming.github.io/tags/webpack/atom.xml" rel="self"/>
  <link href="http://zhaozhiming.github.io/"/>
  <updated>2018-04-29T16:48:16+08:00</updated>
  <id>http://zhaozhiming.github.io/</id>
  <author>
    <name><![CDATA[赵芝明]]></name>
    <email><![CDATA[kingzzm1982@sina.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[如何扩展 Create React App 的 webpack 配置]]></title>
    <link href="http://zhaozhiming.github.io/blog/2018/01/08/create-react-app-override-webpack-config/"/>
    <updated>2018-01-08T20:04:00+08:00</updated>
    <id>http://zhaozhiming.github.io/blog/2018/01/08/create-react-app-override-webpack-config</id>
    <content type="html"><![CDATA[<p><img src="/images/post/2018/01/cra.png" width="400" height="300"></p>

<p><a href="https://github.com/facebookincubator/create-react-app">Create React App</a>（以下简称 CRA）是创建 React 应用的一个脚手架，它与其他脚手架不同的一个地方就是将一些复杂工具（比如 webpack）的配置封装了起来，让使用者不用关心这些工具的具体配置，从而降低了工具的使用难度。</p>

<p>但是对于一些熟悉 webpack 的开发者来说，他们可能想对 webpack 配置做一些修改，这个时候应该怎么办呢？</p>

<!--more-->


<p>其实我们可以通过以下几种方式来修改 webpack 的配置：</p>

<ul>
<li>项目 eject</li>
<li>替换 react-scripts 包</li>
<li>使用 react-app-rewired</li>
<li>scripts 包 + override 组合</li>
</ul>


<p>下面对这几种方式分别进行介绍。</p>

<h2>项目 eject</h2>

<p>使用 CRA 创建完项目以后，项目在<code>package.json</code>里面提供了这样一个命令：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">&amp;hellip;</span>
</span><span class='line'>  <span class="err">&amp;ldquo;scripts&amp;rdquo;:</span> <span class="err">{&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;pre&gt;&lt;code&gt;</span><span class="nt">&quot;eject&quot;</span><span class="p">:</span> <span class="s2">&quot;react-scripts eject&quot;</span>
</span><span class='line'><span class="err">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span>  <span class="p">}</span><span class="err">,</span>
</span><span class='line'>  <span class="err">&amp;hellip;</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>执行完这个命令——<code>yarn run eject</code>后会将封装在 CRA 中的配置全部<code>反编译</code>到当前项目，这样用户就可以完全取得 webpack 文件的控制权，想怎么修改就怎么修改了。</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;eject 后项目根目录下会出现 config 文件夹，里面就包含了 webpack 配置&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;config
</span><span class='line'>├── env.js
</span><span class='line'>├── jest
</span><span class='line'>│   ├── cssTransform.js
</span><span class='line'>│   └── fileTransform.js
</span><span class='line'>├── paths.js
</span><span class='line'>├── polyfills.js
</span><span class='line'>├── webpack.config.dev.js // 开发环境配置
</span><span class='line'>├── webpack.config.prod.js // 生产环境配置
</span><span class='line'>└── webpackDevServer.config.js
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>CRA 与其他脚手架不同的另一个地方，就是可以通过升级其中的<code>react-scripts</code>包来升级 CRA 的特性。比如用老版本 CRA 创建了一个项目，这个项目不具备 <a href="https://developers.google.com/web/progressive-web-apps/">PWA</a> 功能，但只要项目升级了<code>react-scripts</code>包的版本就可以具备 PWA 的功能，项目本身的代码不需要做任何修改。</p>

<p>但如果我们使用了<code>eject</code>命令，就再也享受不到 CRA 升级带来的好处了，因为<code>react-scripts</code>已经是以文件的形式存在于你的项目，而不是以包的形式，所以无法对其升级。</p>

<h2>替换 react-scripts 包</h2>

<p><a href="https://github.com/facebookincubator/create-react-app/tree/8cae659ec5a066eff8ea270346dc8c1ef064f9aa/packages/react-scripts">react-scripts</a> 是 CRA 的一个核心包，一些脚本和工具的默认配置都集成在里面，使用 CRA 创建项目默认就是使用这个包，但是 CRA 还提供了另外一种方式来创建 CRA 项目，即使用自定义 scripts 包的方式。</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;默认方式&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="nv">$ </span>create-react-app foo&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;自定义 scripts 包方式&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="nv">$ </span>create-react-app foo &amp;mdash;scripts-version 自定义包
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>自定义包</code>可以是下面几种形式：</p>

<ul>
<li><code>react-scripts</code>包的版本号，比如<code>0.8.2</code>，这种形式可以用来安装低版本的<code>react-scripts</code>包。</li>
<li>一个已经发布到 npm 仓库上的包的名字，比如<code>your-scripts</code>，里面包含了修改过的 webpack 配置。</li>
<li>一个 tgz 格式的压缩文件，比如<code>/your/local/scripts.tgz</code>，通常是未发布到 npm 仓库的自定义 scripts 包，可以用 <code>npm pack</code> 命令生成。</li>
</ul>


<p>这种方式相对于之前的<code>eject</code>是一种更灵活地修改 webpack 配置的方式，而且可以做到和 CRA 一样，通过升级 scrips 包来升级项目特性。</p>

<p>自定义 scripts 包的结构可以参照<code>react-scripts</code>包的结构，只要修改对应的 webpack 配置文件，并安装上所需的 webpack loader 或 plugin 包就可以了。</p>

<h2>使用 react-app-rewired</h2>

<p>虽然有这两种方式可以扩展 webpack 配置，但是很多开发者还是觉得太麻烦，有没有一种方式可以既不用<code>eject</code>项目又不用创建自己的 scripts 包呢？答案是肯定的，<a href="https://github.com/timarney/react-app-rewired">react-app-rewired</a> 是 react 社区开源的一个修改 CRA 配置的工具。</p>

<p>在 CRA 创建的项目中安装了<code>react-app-rewired</code>后，可以通过创建一个<code>config-overrides.js</code> 文件来对 webpack 配置进行扩展。</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="err">/&lt;em&gt; config-overrides.js &lt;/em&gt;/&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">override</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//do stuff with the webpack config&amp;hellip;</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">config</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>override</code>方法的第一个参数<code>config</code>就是 webpack 的配置，在这个方法里面，我们可以对 <code>config</code> 进行扩展，比如安装其他 loader 或者 plugins，最后再将这个 <code>config</code> 对象返回回去。</p>

<p>最后再修改<code>package.json</code>中的脚本命令，修改内容请见<a href="https://github.com/timarney/react-app-rewired#3-flip-the-existing-calls-to-react-scripts-in-npm-scripts">这里</a>。</p>

<h2>scripts 包 + override 组合</h2>

<p>虽然<code>react-app-rewired</code>的方式已经可以很方便地修改 webpack 的配置了，但其实我们也可以在自定义的 script 包中实现类似的功能。</p>

<p>在<code>react-app-rewired</code>的源码中可以看到它核心的包也叫 <a href="https://github.com/timarney/react-app-rewired/tree/4954531eaab6da14c4e3c943cb2038b46d5f9125/packages/react-app-rewired">react-app-rewired</a>，里面重新覆盖了<code>react-scripts</code>中的几个脚本文件，包括<code>build.js</code>、<code>start.js</code>和<code>test.js</code>。</p>

<p>具体过程是怎样的呢？以<code>build.js</code>为例：</p>

<ul>
<li>先获取 webpack 的基本配置，然后再调用<code>config-overrides.js</code>（就是在根目录中新增的那个文件）中的<code>override</code>方法，将原先的 webpack 对象作为参数传入，</li>
<li>再取得经过修改后的 webpack 配置对象</li>
<li>最后再调用<code>react-scripts</code>中的<code>build.js</code>脚本，传入修改后的 webpack 对象来执行命令，</li>
</ul>


<p>具体源码如下：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">overrides</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;..</span><span class="o">/</span><span class="nx">config</span><span class="o">-</span><span class="nx">overrides</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;);</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">webpackConfigPath</span> <span class="o">=</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">scriptVersion</span> <span class="o">+</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="err">/config/webpack.config.prod&amp;rdquo;;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="c1">// load original config</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">webpackConfig</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">webpackConfigPath</span><span class="p">);</span>
</span><span class='line'><span class="c1">// override config in memory</span>
</span><span class='line'><span class="nx">require</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">webpackConfigPath</span><span class="p">)].</span><span class="nx">exports</span> <span class="o">=</span>
</span><span class='line'>  <span class="nx">overrides</span><span class="p">.</span><span class="nx">webpack</span><span class="p">(</span><span class="nx">webpackConfig</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="p">);</span>
</span><span class='line'><span class="c1">// run original script</span>
</span><span class='line'><span class="nx">require</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">scriptVersion</span> <span class="o">+</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="err">/scripts/build&amp;rsquo;);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>知道了原理之后，我们也可以修改自定义 scripts 包的脚本文件，还是以<code>build.js</code>为例，在获取基本 webpack 配置对象和使用 webpack 对象之间加入以下代码：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// override config</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">override</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">configOverrides</span><span class="p">);</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">overrideFn</span> <span class="o">=</span> <span class="nx">override</span> <span class="o">||</span> <span class="p">((</span><span class="nx">config</span><span class="p">,</span> <span class="nx">env</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">config</span><span class="p">);</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">overrideConfig</span> <span class="o">=</span> <span class="nx">overrideFn</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>overrideConfig</code>就是修改后的 webpack 对象，最后修改调用了 webpack 对象的代码，将原来的 webpack 对象替换成修改后的 webpack 对象。</p>

<h2>总结</h2>

<p>CRA 是一个非常棒的 React 脚手架工具，但你如果不满足于它的 webpack 默认配置，你可以通过上述几种方式来扩展自己项目的 webpack 配置，这几种方式各有优缺点，可以结合具体的使用场景来选择合适自己的方式。</p>
]]></content>
  </entry>
  
</feed>
