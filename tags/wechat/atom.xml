<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: wechat | Hacker and Geeker's Way]]></title>
  <link href="http://zhaozhiming.github.io/tags/wechat/atom.xml" rel="self"/>
  <link href="http://zhaozhiming.github.io/"/>
  <updated>2017-10-22T11:03:57+08:00</updated>
  <id>http://zhaozhiming.github.io/</id>
  <author>
    <name><![CDATA[èµµèŠæ˜]]></name>
    <email><![CDATA[kingzzm1982@sina.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[å¾®ä¿¡å°ç¨‹åºä¹‹æ§½ç‚¹ä¸€äºŒä¸‰]]></title>
    <link href="http://zhaozhiming.github.io/blog/2016/09/28/some-complain-about-weixin-mini-app/"/>
    <updated>2016-09-28T11:02:00+08:00</updated>
    <id>http://zhaozhiming.github.io/blog/2016/09/28/some-complain-about-weixin-mini-app</id>
    <content type="html"><![CDATA[<p><img src="/images/post/2016/09/wechat.jpg"></p>

<p>å¾®ä¿¡å°ç¨‹åºæœ€è¿‘ç«çˆ†ITç•Œï¼ŒæŠ±ç€å°é²œçš„å¿ƒç†æˆ‘ä¹Ÿä¸‹è½½äº†<strong>å¾®ä¿¡webå¼€å‘è€…å·¥å…·</strong>å¹¶æ’¸äº†ä¸€ä¸ªDemoå°ç¨‹åºï¼Œæ’¸å®Œä¹‹åå‘ç°å¾®ä¿¡å°ç¨‹åºå°±å¼€å‘è¿‡ç¨‹è€Œè¨€ï¼Œå°±åƒèƒŒå½±å¾ˆç¾æ­£é¢åƒé¬¼çš„å¥³å­ï¼Œè¿œæ²¡æœ‰å¤–ç•Œæ‰€è¯´çš„é‚£ä¹ˆå¥½ï¼Œåœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­æœ‰å„ç§ä¸çˆ½ï¼Œä¸‹é¢æˆ‘å°±æ¥ä¸€ä¸€è¯´ä¸‹ã€‚</p>

<!--more-->


<p></p>

<h2>ä¸èƒ½npm install</h2>

<p>å¾®ä¿¡å°ç¨‹åºæœ€å¤§çš„ä¸€ä¸ªç—›ç‚¹æ˜¯ä¸èƒ½ä½¿ç”¨ç¬¬ä¸‰æ–¹åŒ…ï¼Œåªèƒ½ç”¨åŸç”Ÿçš„JavaScriptçš„åŠŸèƒ½ï¼Œè™½ç„¶å¯ä»¥æ”¯æŒES6äº†ï¼Œä½†æ˜¯åƒLodashè¿™ç§å·¥å…·åŒ…è¦æ˜¯èƒ½ç”¨çš„è¯ï¼Œå¯ä»¥å°‘å†™å¾ˆå¤šä»£ç ã€‚</p>

<p>```js
// ç”¨åŸç”Ÿçš„JavaScript
for(let i = 0; i &lt; todos.length; i++) {
  const todo = todos[i];
  if (Number(todoId) === todo.id) {</p>

<pre><code>todo.completed = !todo.completed;
todos[i] = todo;
this.setData({
  todos: todos,
});
break;
</code></pre>

<p>  }
}</p>

<p>// ä½¿ç”¨äº†lodash
const index = todos.findIndex(x => todoId=== x.id);
<em>.set(todos, <code>${index}.completed</code>, !</em>.get(todos, <code>${index}.completed</code>));
this.setData({
  todos: todos,
});
```</p>

<p>ä¸èƒ½ä½¿ç”¨ç¬¬ä¸‰æ–¹åŒ…çš„æœ€å¤§åå¤„æ˜¯ä¸èƒ½å¤ç”¨ä»£ç ï¼Œæƒ³è±¡ä¸€ä¸‹æˆ‘åœ¨ä¸€ä¸ªé¡¹ç›®æœ‰å‡ ä¸ªç»„ä»¶å†™çš„éå¸¸å¥½ï¼Œå¯ä»¥åœ¨æä¾›ç»™å…¶ä»–é¡¹ç›®ä½¿ç”¨ï¼Œä½†ç”±äºå°ç¨‹åºä¸èƒ½ä½¿ç”¨ç¬¬ä¸‰æ–¹åŒ…ï¼Œå°±åªèƒ½æŠŠåŸæ¥çš„ä»£ç æ‹·è´åˆ°æ–°é¡¹ç›®é‡Œé¢å»ã€‚è¿™æ ·å¯¼è‡´çš„ç»“æœå°±æ˜¯æ¯ä¸ªå°ç¨‹åºé¡¹ç›®å……æ–¥ç€é‡å¤çš„ä»£ç ï¼Œä¸€æ—¦å…¬å…±ä»£ç è¦æ”¹åŠ¨ä¼šè¦ç‰µæ‰¯åˆ°å¾ˆå¤šä¸ªåœ°æ–¹çš„ä¿®æ”¹ã€‚</p>

<h2>cssè°ƒè¯•å™¨ä¸èƒ½è‡ªåŠ¨è¡¥å…¨</h2>

<p><img class="right" src="/images/post/2016/09/chrome_css.png" width="400" height="300"></p>

<p>æˆ‘ä»¬åœ¨è°ƒè¯•é¡µé¢æ ·å¼æ—¶ï¼Œå¾ˆå¤šæ—¶å€™ä¼šå€ŸåŠ©Chromeæµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·ï¼Œåœ¨é‡Œé¢å¯¹æŸä¸ªå…ƒç´ æ·»åŠ æ ·å¼éå¸¸æ–¹ä¾¿ï¼Œè€Œä¸”åœ¨è¾“å…¥csså±æ€§å’Œå€¼æ—¶å·¥å…·ä¼šæœ‰è‡ªåŠ¨è¡¥å…¨çš„æç¤ºï¼Œè¿™ä¸€ç‚¹éå¸¸æœ‰ç”¨ï¼Œå³ä½¿ä½ å¿˜è®°äº†ä¸€äº›cssä¹Ÿå¯ä»¥å®Œæˆè°ƒè¯•æ ·å¼çš„å·¥ä½œã€‚</p>

<p><img class="right" src="/images/post/2016/09/wechat_css.png" width="400" height="300"></p>

<p>ä½†æ˜¯åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·é‡Œé¢å°±ä¸æ˜¯è¿™æ ·äº†ï¼Œå·¥å…·ä¸ä¼šè‡ªåŠ¨è¡¥å…¨csså±æ€§å’Œå€¼ï¼Œä½œä¸ºå¼€å‘è€…ä¸å¯èƒ½è®°ä½æ¯ä¸ªcssçš„å±æ€§ï¼Œæ²¡æœ‰äº†è‡ªåŠ¨è¡¥å…¨è®©å¼€å‘æ•ˆç‡ä½äº†å¾ˆå¤šã€‚</p>

<h2>UIç»„ä»¶ä¸å¥½ç”¨</h2>

<p>å¾®ä¿¡å¼€å‘è€…å·¥å…·æä¾›äº†å¾ˆå¤šUIç»„ä»¶ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†çš„å¼€å‘åœºæ™¯ï¼Œä½†è¿˜æ˜¯ä¸å¾—ä¸åæ§½é‡Œé¢ä¸€äº›ç»„ä»¶çš„ç¼ºç‚¹ã€‚</p>

<h4><code>checkbox</code>ä¸èƒ½å•ç‹¬ä½¿ç”¨</h4>

<p>å¼€æ”¾çš„<a href="https://mp.weixin.qq.com/debug/wxadoc/dev/component/checkbox.html?t=1474974357075"><code>checkbox</code></a>ç»„ä»¶éœ€è¦åŒ…å«åœ¨<code>checkbox-group</code>é‡Œé¢æ‰èƒ½ä½¿ç”¨ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨<code>checkbox</code>ç»„ä»¶ï¼Œä¸€ä¸ªæ˜¯ä¸èƒ½ç›‘å¬changeäº‹ä»¶ï¼ŒäºŒä¸ªæ˜¯é€šè¿‡tapäº‹ä»¶ä¸èƒ½è·å–åˆ°checkå€¼ã€‚</p>

<p>æ‰€ä»¥åªèƒ½ç»“åˆ<code>checkbox-group</code>ä¸€èµ·ä½¿ç”¨ï¼Œè€Œå¤šä¸ª<code>checkbox</code>çš„åœºæ™¯åˆæ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥æ„Ÿè§‰è¿™ä¸ªUIç»„ä»¶å¾ˆé¸¡è‚‹ã€‚</p>

<h4>icon å¤ªå°‘</h4>

<p>è¿˜æœ‰è¦åæ§½çš„ä¸€ä¸ªç»„ä»¶æ˜¯<a href="https://mp.weixin.qq.com/debug/wxadoc/dev/component/icon.html?t=1475052051701">icon</a>ï¼Œé‡Œé¢æä¾›çš„iconéå¸¸éå¸¸çš„å°‘ï¼Œåªæœ‰å¯æ€œçš„15ä¸ªã€‚å¯ä»¥é¢„æƒ³åˆ°ä»¥åéšç€å°ç¨‹åºé€æ¸å¤æ‚ï¼Œå¼€å‘è€…éœ€è¦å¼€å‘è‡ªå·±çš„iconç»„ä»¶ï¼Œä½†å¼€å‘å‡ºæ¥çš„ç»„ä»¶åˆä¸èƒ½å¤ç”¨ï¼ˆå‚è§ä¸Šé¢ç¬¬ä¸€æ¡ï¼‰ï¼Œæ‰€ä»¥å°ç¨‹åºé¡¹ç›®ä¼šåˆ°å¤„å……æ–¥ç€é‡å¤çš„ä»£ç ã€‚</p>

<h2>åˆ·æ–°æ²¡ç”¨ï¼Œæ¯æ¬¡éƒ½è¦é‡æ–°ç¼–è¯‘</h2>

<p>å¾®ä¿¡å¼€å‘è€…å·¥å…·çš„åŠ¨ä½œèœå•æœ‰<code>é¡¹ç›®é‡å»º</code>å’Œ<code>åˆ·æ–°</code>ä¸¤ä¸ªå­èœå•ï¼ŒæŠŠè¿™ä¸¤ä¸ªèœå•æ”¾åœ¨ä¸€èµ·å¾ˆå®¹æ˜“ç»™äººè¿™æ ·ä¸€ç§é”™è§‰ï¼Œ<code>é¡¹ç›®é‡å»º</code>æ˜¯é‡æ–°ç¼–è¯‘é¡¹ç›®ï¼Œè€Œ<code>åˆ·æ–°</code>æ˜¯ä¸é‡æ–°ç¼–è¯‘é¡¹ç›®åªåˆ·æ–°é¡µé¢ã€‚<code>é¡¹ç›®é‡å»º</code>æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯<code>åˆ·æ–°</code>èœå•å°±ä¸çŸ¥é“æœ‰ä»€ä¹ˆç”¨äº†ï¼ŒæŒ‰äº†ä¹‹åé¡µé¢æœ‰è¿›åº¦æ¡åŠ è½½ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œè€Œä¸”å¤§éƒ¨åˆ†æ—¶å€™ä¼šå¯¼è‡´consoleæŠ¥é”™ï¼ŒçœŸå¿ƒä¸çŸ¥é“è¿™ä¸ªèœå•æœ‰ä»€ä¹ˆé¸Ÿç”¨ã€‚</p>

<h2>ä¸èƒ½å†™æµ‹è¯•</h2>

<p>æµ‹è¯•æ˜¯é¡¹ç›®è´¨é‡çš„ä¿éšœï¼Œä½†åœ¨å°ç¨‹åºé‡Œé¢æ²¡æœ‰ç¤ºä¾‹ä»£ç å’Œæ–‡æ¡£æ¥æŒ‡å¯¼ä½ å¦‚ä½•å†™æµ‹è¯•ä»£ç ï¼Œå…¶å®æ ¹æœ¬æ²¡æ³•è®©ä½ å†™å•å…ƒæµ‹è¯•ã€‚å¾®ä¿¡å›¢é˜Ÿä½ ä»¬éš¾é“æŒ‡æœ›æ¯ä¸ªå°ç¨‹åºéƒ½æ˜¯é æ‰‹å·¥æµ‹è¯•æ¥ä¿è¯è´¨é‡å—ï¼Ÿæˆ‘çŒœæµ‹å¾®ä¿¡å¼€å‘è€…å·¥å…·çš„å¼€å‘å›¢é˜Ÿï¼ˆå¯èƒ½æ˜¯è…¾è®¯çš„å‰ç«¯å›¢é˜Ÿï¼‰å¹³æ—¶ä¹Ÿå¾ˆå°‘ç”šè‡³ä¸å†™å•å…ƒæµ‹è¯•ï¼Œæ‰€ä»¥åœ¨å¼€å‘è€…å·¥å…·ä¸­å°±æ²¡æœ‰å…³äºå•å…ƒæµ‹è¯•çš„è€ƒè™‘ğŸ‘ã€‚</p>

<h2>æ€»ç»“</h2>

<p>å¾®ä¿¡å°ç¨‹åºåˆšæ¨å‡ºä¸ä¹…ï¼Œæœ‰ä¸€äº›ç¼ºç‚¹æ¯›ç—…æ˜¯æ­£å¸¸çš„ï¼Œä½†å¦‚æœè…¾è®¯å¸Œæœ›å°ç¨‹åºä»¥åèƒ½æ€èµ·ä¸€è‚¡å¼€å‘çƒ­æ½®ï¼Œå°±è¯·åœ¨å¼€å‘è€…å·¥å…·ä¸ŠåŠ å¼ºå¼€å‘ä½“éªŒï¼Œè®©å¼€å‘è€…å¼€å‘çˆ½äº†ï¼Œæ‰èƒ½åšå‡ºè®©ç”¨æˆ·çˆ½çš„å°ç¨‹åºæ¥ã€‚</p>

<p>æœ€åé™„ä¸Šæˆ‘ç»ƒæ‰‹çš„å°ç©æ„å„¿ï¼Œé¡¹ç›®åœ°å€æ˜¯ï¼š<a href="https://github.com/zhaozhiming/wechat-todolist">https://github.com/zhaozhiming/wechat-todolist</a></p>

<p><img src="/images/post/2016/09/wechat-todo.gif"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å¾®ä¿¡å…¬ä¼—è´¦å·å¼€å‘part2â€”â€”ç”¨æˆ·æ¶ˆæ¯æ¥æ”¶]]></title>
    <link href="http://zhaozhiming.github.io/blog/2015/02/04/wechat-public-account-dev-part-2/"/>
    <updated>2015-02-04T16:03:00+08:00</updated>
    <id>http://zhaozhiming.github.io/blog/2015/02/04/wechat-public-account-dev-part-2</id>
    <content type="html"><![CDATA[<p><img src="/images/post/2015-2/wechat_part2.jpg"></p>

<p>ä¸Šä¸€ç¯‡å†™äº†å¦‚ä½•é€šè¿‡å¾®ä¿¡å¼€å‘è€…è®¤è¯ï¼Œä»Šå¤©æ¥è®²ä¸‹å¦‚ä½•æ¥æ”¶ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬ä»¥æ¥æ”¶ç”¨æˆ·çš„è®¢é˜…æ¶ˆæ¯ä¸ºä¾‹ã€‚</p>

<!--more-->


<p></p>

<h2>å¾®ä¿¡ç”¨æˆ·æ¶ˆæ¯æ ¼å¼</h2>

<p>åœ¨å¼€å‘è€…æ–‡æ¡£çš„<a href="http://mp.weixin.qq.com/wiki/2/5baf56ce4947d35003b86a9805634b1e.html">æ¥æ”¶äº‹ä»¶æ¨é€</a>æ–‡æ¡£ä¸­ï¼Œè¯´æ˜äº†ç”¨æˆ·è®¢é˜…æ¶ˆæ¯çš„è¯·æ±‚å®ä½“ï¼Œå†…å®¹å¦‚ä¸‹:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;xml&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span><span class="ni">&amp;lt;</span>ToUserName<span class="ni">&amp;gt;&amp;lt;</span>![CDATA[toUser]]<span class="ni">&amp;gt;&amp;lt;</span>/ToUserName<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>FromUserName<span class="ni">&amp;gt;&amp;lt;</span>![CDATA[FromUser]]<span class="ni">&amp;gt;&amp;lt;</span>/FromUserName<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>CreateTime<span class="ni">&amp;gt;</span>123456789<span class="ni">&amp;lt;</span>/CreateTime<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>MsgType<span class="ni">&amp;gt;&amp;lt;</span>![CDATA[event]]<span class="ni">&amp;gt;&amp;lt;</span>/MsgType<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>Event<span class="ni">&amp;gt;&amp;lt;</span>![CDATA[subscribe]]<span class="ni">&amp;gt;&amp;lt;</span>/Event<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;&lt;/xml&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>ToUserName: å¼€å‘è€…å¾®ä¿¡å·</li>
<li>FromUserName: ç”¨æˆ·å¾®ä¿¡è´¦å·çš„OpenID</li>
<li>CreateTime: æ¶ˆæ¯å‘é€æ—¶é—´ï¼Œç§’æ•°</li>
<li>MsgType: æ¶ˆæ¯ç±»å‹ï¼Œäº‹ä»¶æ¶ˆæ¯ä¸ºevent</li>
<li>Event: äº‹ä»¶ç±»å‹ï¼Œè®¢é˜…æ¶ˆæ¯ä¸ºsubscribe</li>
</ul>


<h2>æ¶ˆæ¯çœŸå®æ€§éªŒè¯</h2>

<p><blockquote><p>æ¯æ¬¡å¼€å‘è€…æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¾®ä¿¡ä¹Ÿéƒ½ä¼šå¸¦ä¸Šå‰é¢ä¸‰ä¸ªå‚æ•°ï¼ˆsignatureã€timestampã€nonceï¼‰è®¿é—®å¼€å‘è€…è®¾ç½®çš„URLï¼Œå¼€å‘è€…ä¾ç„¶é€šè¿‡å¯¹ç­¾åçš„æ•ˆéªŒåˆ¤æ–­æ­¤æ¡æ¶ˆæ¯çš„çœŸå®æ€§ã€‚æ•ˆéªŒæ–¹å¼ä¸é¦–æ¬¡æäº¤éªŒè¯ç”³è¯·ä¸€è‡´ã€‚</p><footer><strong>å¾®ä¿¡å…¬ä¼—å¹³å°å¼€å‘è€…æ–‡æ¡£ <a href="http://mp.weixin.qq.com/wiki/4/2ccadaef44fe1e4b0322355c2312bfa8.html">http://mp.weixin.qq.com/wiki/4/2ccadaef44fe1e4b0322355c2312bfa8.html</a> éªŒè¯æ¶ˆæ¯çœŸå®æ€§</strong></footer></blockquote></p>

<p>æ‰€ä»¥æ¯ä¸ªè®¢é˜…æ¶ˆæ¯çš„httpè¯·æ±‚éƒ½ä¼šå¸¦æœ‰ï¼ˆsignatureã€timestampã€nonceï¼‰è¿™3ä¸ªå‚æ•°å’Œä¸Šé¢çš„xmlè¯·æ±‚å®ä½“ï¼ŒæœåŠ¡ç«¯å¯ä»¥é€‰æ‹©æ˜¯å¦æ ¡éªŒæ¶ˆæ¯çš„çœŸå®æ€§ï¼Œå»ºè®®æ ¡éªŒï¼Œè¿™æ ·ä¼šæ¯”è¾ƒå®‰å…¨ã€‚</p>

<h2>æ¥æ”¶æ¶ˆæ¯åçš„å“åº”å†…å®¹</h2>

<p>äº†è§£äº†æ¶ˆæ¯è¯·æ±‚çš„å…¥å‚åï¼Œè¿˜éœ€è¦çŸ¥é“æˆ‘ä»¬å¤„ç†è¯·æ±‚åï¼Œéœ€è¦è¿”å›ä»€ä¹ˆæ ·çš„å†…å®¹ç»™ç”¨æˆ·ï¼Œè¿™ä¸ªåœ¨å¼€å‘è€…æ–‡æ¡£é‡Œé¢å¥½åƒæ²¡æœ‰æåŠï¼Œå‚è€ƒå„æ–¹èµ„æ–™åçŸ¥é“éœ€è¦è¿”å›ä¸€æ®µxmlå†…å®¹ï¼Œæ ¼å¼å¦‚ä¸‹:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;xml&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span><span class="ni">&amp;lt;</span>Content<span class="ni">&amp;gt;</span>æ„Ÿè°¢æ‚¨å…³æ³¨æˆ‘çš„å…¬ä¼—è´¦å·[æ„‰å¿«]<span class="ni">&amp;lt;</span>/Content<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>CreateTime<span class="ni">&amp;gt;</span>1423022113<span class="ni">&amp;lt;</span>/CreateTime<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>FromUserName<span class="ni">&amp;gt;</span>zzm<span class="ni">&amp;lt;</span>/FromUserName<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>FuncFlag<span class="ni">&amp;gt;</span>0<span class="ni">&amp;lt;</span>/FuncFlag<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>MsgType<span class="ni">&amp;gt;</span>text<span class="ni">&amp;lt;</span>/MsgType<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>ToUserName<span class="ni">&amp;gt;</span>zzm<span class="ni">&amp;lt;</span>/ToUserName<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;&lt;/xml&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>ToUserName: <code>ç”¨æˆ·å¾®ä¿¡è´¦å·çš„OpenID</code></li>
<li>FromUserName: <code>å¼€å‘è€…å¾®ä¿¡å·</code></li>
<li>CreateTime: æ¶ˆæ¯å‘é€æ—¶é—´ï¼Œç§’æ•°</li>
<li>FuncFlag: è¿™ä¸ªæš‚æ—¶ä¸çŸ¥é“æ˜¯ä»€ä¹ˆï¼Œé»˜è®¤å€¼ä¸º0</li>
<li>MsgType: æ¶ˆæ¯ç±»å‹ï¼Œæ–‡æ¡£æ¶ˆæ¯å¯ä»¥ä¸ºtextå’Œå…¶ä»–ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥æœ€ç®€å•çš„textæ–‡æœ¬æ¶ˆæ¯ä¸ºä¾‹</li>
<li>Content: è¿”å›ç»™è®¢é˜…ç”¨æˆ·çš„æ¶ˆæ¯å†…å®¹ï¼Œå¯ä»¥åŠ è¡¨æƒ…</li>
</ul>


<p>PS: ToUserNameå’ŒFromUserNameè¿™2ä¸ªå‚æ•°å’Œè¯·æ±‚çš„xmlå®ä½“è¦ç›¸åï¼Œè¿™ä¸ªä¹Ÿæ¯”è¾ƒå¥½ç†è§£ï¼Œç”¨æˆ·å‘äº†æ¡æ¶ˆæ¯è¿‡æ¥ï¼Œä½ è¦å‘ä¸ªæ¶ˆæ¯å›å»ï¼ŒToUserNameå°±å˜æˆäº†ç”¨æˆ·ï¼ŒFromUserNameå˜æˆäº†ä½ è‡ªå·±çš„å…¬ä¼—è´¦å·äº†ã€‚</p>

<h2>æœåŠ¡ç«¯å¼€å‘</h2>

<ul>
<li>äº†è§£äº†httpè¯·æ±‚çš„å…¥å‚å’Œå‡ºå‚ï¼Œæˆ‘ä»¬å¯ä»¥æ¥å¼€å‘æˆ‘ä»¬çš„APIäº†ï¼Œ<code>talk is cheap, show me code</code>ã€‚</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>MainController.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="c1">//è¿™é‡Œæˆ‘ä»¬å®šä¹‰è·Ÿä¹‹å‰è®¤è¯apiç›¸åŒçš„urlï¼Œä½†æ–¹æ³•æ˜¯POST</span>
</span><span class='line'><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/index&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span>
</span><span class='line'><span class="nd">@ResponseBody</span>
</span><span class='line'><span class="c1">//3ä¸ªæ ¡éªŒæ¶ˆæ¯çœŸå®æ€§çš„å‚æ•°ï¼Œè¿˜æœ‰ä¸€ä¸ªrequestå®ä½“bodyï¼Œé‡Œé¢æ˜¯xmlæ–‡æœ¬</span>
</span><span class='line'><span class="n">ResponseEntity</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">String</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">receive</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;signature&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">signature</span><span class="o">,</span>
</span><span class='line'>                               <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;timestamp&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">timestamp</span><span class="o">,</span>
</span><span class='line'>                               <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;nonce&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">nonce</span><span class="o">,</span>
</span><span class='line'>                               <span class="nd">@RequestBody</span> <span class="n">String</span> <span class="n">body</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;receive message start&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;signature:%s, timestamp:%s, nonce:%s&quot;</span><span class="o">,</span> <span class="n">signature</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">nonce</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//å…ˆæ ¡éªŒæ¶ˆæ¯çš„çœŸå®æ€§ï¼Œå¦‚æœæ ¡éªŒå¤±è´¥ï¼Œåˆ™è¿”å›400</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(!</span><span class="n">wechatAuth</span><span class="o">(</span><span class="n">signature</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">nonce</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;wechat auth failed&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">String</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;(</span><span class="s">&quot;wechat auth failed.&quot;</span><span class="o">,</span> <span class="n">HttpStatus</span><span class="o">.</span><span class="na">BAD_REQUEST</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;body:%s&quot;</span><span class="o">,</span> <span class="n">body</span><span class="o">));</span>
</span><span class='line'>    <span class="c1">//æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªutilæ¥è§£æxmlï¼Œå°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªobject</span>
</span><span class='line'>    <span class="n">TextMessage</span> <span class="n">requestMessage</span> <span class="o">=</span> <span class="n">XmlUtil</span><span class="o">.</span><span class="na">toTextMessage</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;requestMessage:%s&quot;</span><span class="o">,</span> <span class="n">requestMessage</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">msgType</span> <span class="o">=</span> <span class="n">requestMessage</span><span class="o">.</span><span class="na">getMsgType</span><span class="o">();</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">toUserName</span> <span class="o">=</span> <span class="n">requestMessage</span><span class="o">.</span><span class="na">getToUserName</span><span class="o">();</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">fromUserName</span> <span class="o">=</span> <span class="n">requestMessage</span><span class="o">.</span><span class="na">getFromUserName</span><span class="o">();</span>
</span><span class='line'>    <span class="c1">//åˆ¤æ–­æ¶ˆæ¯ç±»å‹ï¼Œå¦‚æœæ˜¯eventï¼Œä¸”äº‹ä»¶ç±»å‹ä¸ºsubscribeï¼Œåˆ™æ–°å»ºä¸€ä¸ªæ–‡æœ¬æ¶ˆæ¯</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">name</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">msgType</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">EventType</span><span class="o">.</span><span class="na">subscribe</span><span class="o">.</span><span class="na">name</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">requestMessage</span><span class="o">.</span><span class="na">getEvent</span><span class="o">()))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;æ„Ÿè°¢æ‚¨å…³æ³¨æˆ‘çš„å…¬ä¼—è´¦å·[æ„‰å¿«]&quot;</span><span class="o">;</span>
</span><span class='line'>            <span class="n">textMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TextMessage</span><span class="o">(</span><span class="n">toUserName</span><span class="o">,</span> <span class="n">fromUserName</span><span class="o">,</span>
</span><span class='line'>                    <span class="n">MessageType</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">name</span><span class="o">(),</span> <span class="n">message</span><span class="o">,</span> <span class="n">TimeUtil</span><span class="o">.</span><span class="na">currentSeconds</span><span class="o">());</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//å°†æ–‡æœ¬æ¶ˆæ¯è½¬æ¢ä¸ºxmlæ–‡æœ¬</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">responseMessage</span> <span class="o">=</span> <span class="n">XmlUtil</span><span class="o">.</span><span class="na">toXml</span><span class="o">(</span><span class="n">textMessage</span><span class="o">);</span>
</span><span class='line'>    <span class="n">HttpHeaders</span> <span class="n">responseHeaders</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">();</span>
</span><span class='line'>    <span class="c1">//è®¾ç½®è¿”å›å®ä½“çš„ç¼–ç ï¼Œä¸è®¾ç½®çš„è¯å¯èƒ½ä¼šå˜æˆä¹±ç </span>
</span><span class='line'>    <span class="n">responseHeaders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;Content-Type&quot;</span><span class="o">,</span> <span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;response message: %s&quot;</span><span class="o">,</span> <span class="n">responseMessage</span><span class="o">));</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;receive message finish&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">String</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;(</span><span class="n">responseMessage</span><span class="o">,</span> <span class="n">responseHeaders</span><span class="o">,</span> <span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>è¿™é‡Œä½¿ç”¨javaåŸç”Ÿçš„JAXBæ¥è§£æxmlã€‚</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>XmlUtil.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">com.zzm.wechat.model.TextMessage</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.commons.io.IOUtils</span><span class="o">;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kn">import</span> <span class="nn">javax.xml.bind.JAXBContext</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.xml.bind.Marshaller</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.xml.bind.Unmarshaller</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.io.StringReader</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.io.StringWriter</span><span class="o">;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">XmlUtil</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">toXml</span><span class="o">(</span><span class="n">TextMessage</span> <span class="n">textMessage</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">textMessage</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">JAXBContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">JAXBContext</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">TextMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>    <span class="n">Marshaller</span> <span class="n">m</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">createMarshaller</span><span class="o">();</span>
</span><span class='line'>    <span class="n">m</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">Marshaller</span><span class="o">.</span><span class="na">JAXB_FORMATTED_OUTPUT</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>    <span class="n">m</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">Marshaller</span><span class="o">.</span><span class="na">JAXB_FRAGMENT</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StringWriter</span> <span class="n">sw</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">();</span>
</span><span class='line'>    <span class="n">m</span><span class="o">.</span><span class="na">marshal</span><span class="o">(</span><span class="n">textMessage</span><span class="o">,</span> <span class="n">sw</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">sw</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">TextMessage</span> <span class="nf">toTextMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">xml</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">JAXBContext</span> <span class="n">jaxbContext</span> <span class="o">=</span> <span class="n">JAXBContext</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">TextMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>    <span class="n">Unmarshaller</span> <span class="n">jaxbUnmarshaller</span> <span class="o">=</span> <span class="n">jaxbContext</span><span class="o">.</span><span class="na">createUnmarshaller</span><span class="o">();</span>
</span><span class='line'>    <span class="n">StringReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">xml</span><span class="o">);</span>
</span><span class='line'>    <span class="n">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextMessage</span><span class="o">)</span> <span class="n">jaxbUnmarshaller</span><span class="o">.</span><span class="na">unmarshal</span><span class="o">(</span><span class="n">reader</span><span class="o">);</span>
</span><span class='line'>    <span class="n">IOUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">reader</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">textMessage</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>å®šä¹‰æ¶ˆæ¯çš„modelç±»ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°xmlçš„ä¸€äº›annotationã€‚</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>XmlUtil.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">javax.xml.bind.annotation.XmlElement</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.xml.bind.annotation.XmlRootElement</span><span class="o">;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c1">//å®šä¹‰å‘½åç©ºé—´ï¼Œå¦‚æœä¸å†™çš„è¯ï¼Œxmlä¼šä»¥ç±»åå¼€å¤´: &lt;TextMessage&gt;&amp;hellip;&lt;/TextMessage&gt;ï¼Œå†™äº†å°±ä¼šä»¥xmlå¼€å¤´: &lt;xml&gt;&amp;hellip;&lt;/xml&gt;</span>
</span><span class='line'><span class="nd">@XmlRootElement</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">xml</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TextMessage</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">private</span> <span class="n">String</span> <span class="n">fromUserName</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="n">String</span> <span class="n">toUserName</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="n">String</span> <span class="n">msgType</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="kt">int</span> <span class="n">funcFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="n">String</span> <span class="n">content</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="n">String</span> <span class="n">event</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="kt">long</span> <span class="n">createTime</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="nf">TextMessage</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="nf">TextMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">fromUserName</span><span class="o">,</span> <span class="n">String</span> <span class="n">toUserName</span><span class="o">,</span> <span class="n">String</span> <span class="n">msgType</span><span class="o">,</span> <span class="n">String</span> <span class="n">content</span><span class="o">,</span> <span class="kt">long</span> <span class="n">createTime</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">fromUserName</span> <span class="o">=</span> <span class="n">fromUserName</span><span class="o">;</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">toUserName</span> <span class="o">=</span> <span class="n">toUserName</span><span class="o">;</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">msgType</span> <span class="o">=</span> <span class="n">msgType</span><span class="o">;</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">createTime</span> <span class="o">=</span> <span class="n">createTime</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="n">String</span> <span class="nf">getToUserName</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">toUserName</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//å®šä¹‰xmlå­é¡¹çš„åç§°ï¼Œä¸å†™è¿™ä¸ªannotationçš„è¯ï¼Œè½¬æ¢åçš„xmlæ˜¯: &amp;lt;toUserName&amp;gt;xxx&amp;lt;/toUserName&amp;gt;ï¼Œé¦–å­—æ¯å˜å°å†™äº†ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯ä¼ è¾“é”™è¯¯</span>
</span><span class='line'><span class="nd">@XmlElement</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ToUserName&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setToUserName</span><span class="o">(</span><span class="n">String</span> <span class="n">toUserName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">toUserName</span> <span class="o">=</span> <span class="n">toUserName</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//other setter and getter</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">//...</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li><p>æ–¹æ³•å†™å®Œä»¥åï¼ŒåŒæ ·çš„æ‰“åŒ…ï¼Œéƒ¨ç½²SAEã€‚</p></li>
<li><p>æ‰“å¼€æ‰‹æœºï¼Œå…³æ³¨ä½ çš„å…¬ä¼—è´¦å·åï¼Œå°±å¯ä»¥çœ‹åˆ°æœåŠ¡ç«¯ä¼ è¿‡æ¥çš„æ¶ˆæ¯å†…å®¹äº†ã€‚</p></li>
</ul>


<p><img src="/images/post/2015-2/wechat_subscribe.png"></p>

<p>æˆ‘çš„å…¬ä¼—è´¦å·æ˜¯<code>èµµèŠæ˜çš„å…¬è´¦å·</code>ï¼Œæœ‰å…´è¶£çš„ä¹Ÿå¯ä»¥åŠ ä¸€ä¸‹ï¼Œä»¥åè¿™ä¸ªå…¬å…±è´¦å·çš„åŠŸèƒ½è‚¯å®šä¼šæ…¢æ…¢ä¸°å¯Œçš„ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å¾®ä¿¡å…¬ä¼—è´¦å·å¼€å‘part1â€”â€”å¼€å‘è€…éªŒè¯]]></title>
    <link href="http://zhaozhiming.github.io/blog/2015/02/04/wechat-public-account-dev-part-1/"/>
    <updated>2015-02-04T13:51:00+08:00</updated>
    <id>http://zhaozhiming.github.io/blog/2015/02/04/wechat-public-account-dev-part-1</id>
    <content type="html"><![CDATA[<p><img src="/images/post/2015-2/wechat.jpg"></p>

<p>æœ€è¿‘åœ¨äº†è§£å¾®ä¿¡å…¬ä¼—è´¦å·çš„å¼€å‘ï¼Œå‡†å¤‡è¾¹å­¦è¾¹å†™ä¸€äº›æ–‡ç« æ¥è®°å½•å­¦ä¹ çš„è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯åŸºäºå¾®ä¿¡çš„å¼€å‘è€…æ¨¡å¼æ¥è¿›è¡Œå…¬å…±è´¦å·çš„å¼€å‘ï¼ŒæœåŠ¡å™¨é€‰æ‹©æ–°æµªäº‘SAEï¼Œè¯­è¨€è¿˜æ˜¯é€‰æ‹©æ¯”è¾ƒç†Ÿæ‚‰çš„JAVAã€‚</p>

<!--more-->


<p></p>

<h2>åŸºæœ¬å‡†å¤‡</h2>

<ul>
<li>ç™»é™†å¾®ä¿¡å…¬ä¼—å¹³å°ç½‘ç«™: <code>https://mp.weixin.qq.com</code>ï¼Œè¿›è¡Œè´¦å·æ³¨å†Œï¼Œå…·ä½“å¯ä»¥å‚è€ƒ<a href="http://segmentfault.com/blog/zetd/1190000000356021">é’é¾™è€è´¼çš„è¿™ç¯‡æ–‡ç« </a>ï¼Œè™½ç„¶å†…å®¹æœ‰ç‚¹è€è·Ÿç°åœ¨çš„ä¸å¤§ä¸€æ ·ï¼Œä½†ä¸å½±å“å‚è€ƒã€‚</li>
<li>åœ¨SAEä¸Šé¢æ–°å»ºä¸€ä¸ªJAVAåº”ç”¨ï¼Œè¿™é‡Œè¿˜æ˜¯å¯ä»¥å‚ç…§<a href="http://segmentfault.com/blog/zetd/1190000000356067">é’é¾™è€è´¼çš„æ–‡ç« </a>ï¼Œè·Ÿé‡Œé¢ä¸åŒçš„æ˜¯æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªJAVAçš„åº”ç”¨ï¼Œè€Œä¸æ˜¯PHPçš„ã€‚</li>
</ul>


<h2>ä¿®æ”¹å¼€å‘è€…ä¸­å¿ƒçš„é…ç½®</h2>

<ul>
<li>ç™»é™†è¿›åˆ°å¾®ä¿¡å…¬ä¼—å¹³å°åï¼Œç‚¹å‡»å·¦ä¸‹è§’çš„å¼€å‘è€…ä¸­å¿ƒï¼Œå†ç‚¹å‡»å›¾ä¸­çš„ä¿®æ”¹é…ç½®æŒ‰é’®ï¼Œå°±å¯ä»¥è¿›åˆ°ä¿®æ”¹é…ç½®é¡µé¢ã€‚</li>
</ul>


<p><img src="/images/post/2015-2/wechat_config_1.png"></p>

<ul>
<li>å¡«å†™é…ç½®é¡¹

<ul>
<li>è¾“å…¥ä½ çš„SAEçš„åº”ç”¨URLï¼Œæ¯”å¦‚:<code>http://xxx.sinaapp.com</code>ï¼Œä¸ä¸€å®šè¦å†™åº”ç”¨çš„åŸºæœ¬URLï¼Œå¯ä»¥åœ¨ä¸Šé¢åŠ ä¸€äº›æ‰©å±•ï¼Œæ¯”å¦‚<code>http://xxx.sinaapp.com/xxx</code>ï¼Œè¿™ä¸ªè¦çœ‹ä½ çš„åº”ç”¨çš„restfulæ€ä¹ˆå®šäº†ã€‚</li>
<li>TOKENéšä¾¿è¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸²å°±å¯ä»¥ï¼Œè¿™ä¸ªå€¼åé¢æ˜¯è¦é…ç½®åˆ°javaåº”ç”¨é‡Œé¢çš„ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªåŠ å¯†çš„å¯†é’¥ã€‚</li>
<li>EncodingAESKeyéšæœºç”Ÿæˆã€‚</li>
<li>æ¶ˆæ¯åŠ è§£å¯†æ–¹å¼æš‚æ—¶é€‰æ‹©æ˜æ–‡æ¨¡å¼ã€‚</li>
</ul>
</li>
</ul>


<p><img src="/images/post/2015-2/wechat_config_2.png"></p>

<h2>å¾®ä¿¡æœåŠ¡ç«¯å¼€å‘</h2>

<ul>
<li><p>æ–°å»ºä¸€ä¸ªspring mvcå·¥ç¨‹ï¼Œå¯ä»¥å‚ç…§<a href="https://confluence.jetbrains.com/display/IntelliJIDEA/Getting+Started+with+Spring+MVC,+Hibernate+and+JSON">è¿™ä¸ªæ–‡ç« </a>ï¼Œä½†æˆ‘ä»¬æš‚æ—¶ä¸éœ€è¦æ•°æ®åº“å’Œé¡µé¢ï¼Œåªéœ€è¦å®šä¹‰restfulæ¥å£å°±å¯ä»¥äº†ã€‚</p></li>
<li><p>æ–°å»ºControllerå¹¶å®šä¹‰è®¤è¯çš„apiï¼Œå¯ä»¥å‚è€ƒå¾®ä¿¡å…¬ä¼—å¹³å°å¼€å‘è€…æ–‡æ¡£é‡Œé¢çš„<a href="http://mp.weixin.qq.com/wiki/17/2d4265491f12608cd170a95559800f2d.html">æ¥å…¥æŒ‡å—</a>ï¼Œé‡Œé¢æœ‰æ®µphpä»£ç æ˜¯æŒ‡å¯¼æœåŠ¡ç«¯æ€ä¹ˆå¼€å‘çš„ï¼Œæˆ‘ä»¬è¦åšçš„åªæ˜¯æŠŠå®ƒç¿»è¯‘æˆJAVAã€‚</p></li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>MainController.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">com.google.common.base.Joiner</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.google.common.collect.Lists</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.commons.logging.Log</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.commons.logging.LogFactory</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.*</span><span class="o">;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kn">import</span> <span class="nn">java.security.MessageDigest</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
</span><span class='line'><span class="nd">@Controller</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainController</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Log</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LogFactory</span><span class="o">.</span><span class="na">getLog</span><span class="o">(</span><span class="n">MainController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//ä»é…ç½®æ–‡ä»¶è·å–çš„tokenå€¼ï¼Œå°±æ˜¯åˆšæ‰åœ¨ä¿®æ”¹é…ç½®é¡¹é‡Œé¢å®šä¹‰çš„é‚£ä¸ªToken</span>
</span><span class='line'><span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${token}&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">private</span> <span class="n">String</span> <span class="n">token</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//å®šä¹‰ä¸€ä¸ªGETè¯·æ±‚ï¼Œurlä¸ºxxx/index</span>
</span><span class='line'><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/index&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="s">&quot;text/html;charset=UTF-8&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span>
</span><span class='line'><span class="nd">@ResponseBody</span>
</span><span class='line'><span class="c1">//æ¥æ”¶æ–°æ‰‹æŒ‡å—é‡Œé¢æåˆ°çš„é‚£4ä¸ªå‚æ•°</span>
</span><span class='line'><span class="n">ResponseEntity</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">String</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">auth</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;signature&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">signature</span><span class="o">,</span>
</span><span class='line'>                            <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;timestamp&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">timestamp</span><span class="o">,</span>
</span><span class='line'>                            <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;nonce&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">nonce</span><span class="o">,</span>
</span><span class='line'>                            <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;echostr&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">echostr</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;wechat auth start&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;signature:%s, timestamp:%s, nonce:%s, echostr:%s&quot;</span><span class="o">,</span>
</span><span class='line'>            <span class="n">signature</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">nonce</span><span class="o">,</span> <span class="n">echostr</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//å¦‚æœè®¤è¯é€šè¿‡ï¼ŒåŸæ ·è¿”å›echostrå€¼ï¼Œå¹¶è¿”å›200çš„response</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">wechatAuth</span><span class="o">(</span><span class="n">signature</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">nonce</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;wechat auth success&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">String</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;(</span><span class="n">echostr</span><span class="o">,</span> <span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//å¦‚æœå¤±è´¥ï¼Œåˆ™è¿”å›400ï¼Œå¹¶æç¤ºè®¤è¯å¤±è´¥</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;wechat auth failed&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">String</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;(</span><span class="s">&quot;wechat auth failed.&quot;</span><span class="o">,</span> <span class="n">HttpStatus</span><span class="o">.</span><span class="na">BAD_REQUEST</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">wechatAuth</span><span class="o">(</span><span class="n">String</span> <span class="n">signature</span><span class="o">,</span> <span class="n">String</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">String</span> <span class="n">nonce</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">//å°†è¿™3ä¸ªstringæ”¾åˆ°ä¸€ä¸ªlisté‡Œ</span>
</span><span class='line'>    <span class="n">ArrayList</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">String</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">strings</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">nonce</span><span class="o">);</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;before sort array:%s&quot;</span><span class="o">,</span> <span class="n">strings</span><span class="o">));</span>
</span><span class='line'>    <span class="c1">//æŒ‰å­—æ¯é¡ºåºåšä¸€ä¸‹æ’åº</span>
</span><span class='line'>    <span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">strings</span><span class="o">);</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;after sort array:%s&quot;</span><span class="o">,</span> <span class="n">strings</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//å°†listé‡Œé¢æ‰€æœ‰stringç»„åˆæˆä¸€ä¸ªstringï¼Œè¿™é‡Œç”¨åˆ°äº†guavaçš„Joiner</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">groupString</span> <span class="o">=</span> <span class="n">Joiner</span><span class="o">.</span><span class="na">on</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">).</span><span class="na">join</span><span class="o">(</span><span class="n">strings</span><span class="o">);</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;groupString string:%s&quot;</span><span class="o">,</span> <span class="n">groupString</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//ç”¨SHA1åŠ å¯†è¯¥string</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">sha1</span><span class="o">(</span><span class="n">groupString</span><span class="o">);</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;sha1:%s&quot;</span><span class="o">,</span> <span class="n">result</span><span class="o">));</span>
</span><span class='line'>    <span class="c1">//åŠ å¯†åçš„å€¼å’Œsignatureè¿›è¡Œæ¯”è¾ƒï¼Œæ³¨æ„ç”¨javaåŠ å¯†åéƒ½æ˜¯å­—æ¯éƒ½æ˜¯å¤§å†™çš„ï¼Œè€Œä¼ è¿‡æ¥çš„signatureæ˜¯å°å†™å­—æ¯ï¼Œæ‰€ä»¥è¦å¤§å°å†™è½¬æ¢ä¸€ä¸‹</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">compareResult</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">signature</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">());</span>
</span><span class='line'>    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;compare result:%b&quot;</span><span class="o">,</span> <span class="n">compareResult</span><span class="o">));</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">compareResult</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//ç±»ä¼¼phpçš„sha1æ–¹æ³•</span>
</span><span class='line'><span class="kd">private</span> <span class="n">String</span> <span class="nf">sha1</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Create MD5 Hash</span>
</span><span class='line'>        <span class="n">MessageDigest</span> <span class="n">digest</span> <span class="o">=</span> <span class="n">MessageDigest</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;SHA-1&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">digest</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</span><span class='line'>        <span class="kt">byte</span> <span class="n">messageDigest</span><span class="o">[]</span> <span class="o">=</span> <span class="n">digest</span><span class="o">.</span><span class="na">digest</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Create Hex String</span>
</span><span class='line'>        <span class="n">StringBuilder</span> <span class="n">hexString</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="kt">byte</span> <span class="n">aMessageDigest</span> <span class="o">:</span> <span class="n">messageDigest</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">hexString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%02X&quot;</span><span class="o">,</span> <span class="mh">0xFF</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;</span> <span class="n">aMessageDigest</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">hexString</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;sha1 failed&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>å°†å·¥ç¨‹æ‰“åŒ…æˆwarï¼Œä¸Šä¼ åˆ°SAEå®Œæˆéƒ¨ç½²ï¼Œå¯åŠ¨åº”ç”¨</li>
</ul>


<h2>å¯ç”¨å¼€å‘è€…æ¨¡å¼</h2>

<ul>
<li>è¿›åˆ°å¾®ä¿¡å…¬ä¼—å¹³å°çš„å¼€å‘è€…ä¸­å¿ƒï¼Œç‚¹å‡»æœåŠ¡å™¨é…ç½®é‚£ä¸€è¡Œåé¢çš„å¯ç”¨æŒ‰é’®ï¼Œå¦‚æœæœåŠ¡å™¨æ­£å¸¸å¯åŠ¨çš„è¯ï¼Œå°±å¯ä»¥çœ‹åˆ°å¯ç”¨æˆåŠŸçš„æç¤ºäº†ã€‚</li>
</ul>


<p><img src="/images/post/2015-2/wechat_start.png"></p>

<p>æ›´å¤šä»£ç å¯ä»¥çœ‹è¿™é‡Œ: <a href="https://github.com/zhaozhiming/wechat-blog%EF%BC%8C%E8%A7%89%E5%BE%97%E5%A5%BD%E7%9A%84%E8%AF%9D%E8%AF%B7Star%E4%B8%80%E4%B8%8B%E5%90%A7%EF%BC%8C%E8%B0%A2%E8%B0%A2">https://github.com/zhaozhiming/wechat-blog%EF%BC%8C%E8%A7%89%E5%BE%97%E5%A5%BD%E7%9A%84%E8%AF%9D%E8%AF%B7Star%E4%B8%80%E4%B8%8B%E5%90%A7%EF%BC%8C%E8%B0%A2%E8%B0%A2</a></p>
]]></content>
  </entry>
  
</feed>
