
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>swift源码详解（X）——common/swob.py - Hacker and Geeker's Way</title>
    <meta name="author" content="赵芝明">
    
	<meta name="description" content="Match类 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
class Match(object): &quot;&quot;&quot; Wraps a Request&#39;s If-[None-]Match header as a friendly &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Hacker and Geeker's Way" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    <link href="http://cdn.staticfile.org/semantic-ui/0.10.0/css/semantic.min.css" rel="stylesheet" type="text/css">

<script src="http://cdn.staticfile.org/semantic-ui/0.10.0/javascript/semantic.min.js"></script>
<script src="/javascripts/monthly_archive.js"></script>
    

</head>


<body>
<div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        Hacker and Geeker's Way
    </div>
</h1>
<br>

<ul id="social-links" style="text-align:center">
  
  <!-- GitHub -->
  <li>
  <a href="http://weibo.com/u/2497707964" class="weibo" title="sinaWeibo"></a>
  </li>
  
  
  <!-- QQ -->
  <li>
  <a href="http://user.qzone.qq.com/4533524" class="qq" title="QQ"></a>
  </li>
  
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/zhaozhiming" class="github" title="Github"></a>
  </li>
  
  
  
  
  
  <!-- LinkedIn -->
  <li>
  <a href="http://www.linkedin.com/in/zhaozhiming" class="linkedin" title="LinkedIn"></a>
  </li>
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

	<div id="toload">
		<div id="content">
			<div class="inner">
	<article class="post">
	<h2 class="title">swift源码详解（X）——common/swob.py</h2>
	<div class="entry-content"><h2>Match类</h2>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">Match</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    Wraps a Request&#39;s If-[None-]Match header as a friendly object.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    :param headerval: value of the header as a str</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headerval</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">headerval</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">):</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&#39;*&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>处理header值的一个类，如果header值有双引号将移除后再添加。</li>
</ul>


<h2>Accept类</h2>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">Accept</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    Wraps a Request&#39;s Accept header as a friendly object.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    :param headerval: value of the header as a str</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># RFC 2616 section 2.2</span>
</span><span class='line'>    <span class="n">token</span> <span class="o">=</span> <span class="s">r&#39;[^()&lt;&gt;@,;:\&quot;/\[\]?={}\x00-\x20\x7f]+&#39;</span>
</span><span class='line'>    <span class="n">qdtext</span> <span class="o">=</span> <span class="s">r&#39;[^&quot;]&#39;</span>
</span><span class='line'>    <span class="n">quoted_pair</span> <span class="o">=</span> <span class="s">r&#39;(?:</span><span class="se">\\</span><span class="s">.)&#39;</span>
</span><span class='line'>    <span class="n">quoted_string</span> <span class="o">=</span> <span class="s">r&#39;&quot;(?:&#39;</span> <span class="o">+</span> <span class="n">qdtext</span> <span class="o">+</span> <span class="s">r&#39;|&#39;</span> <span class="o">+</span> <span class="n">quoted_pair</span> <span class="o">+</span> <span class="s">r&#39;)*&quot;&#39;</span>
</span><span class='line'>    <span class="n">extension</span> <span class="o">=</span> <span class="p">(</span><span class="s">r&#39;(?:\s*;\s*(?:&#39;</span> <span class="o">+</span> <span class="n">token</span> <span class="o">+</span> <span class="s">r&quot;)\s*=\s*&quot;</span> <span class="o">+</span> <span class="s">r&#39;(?:&#39;</span> <span class="o">+</span> <span class="n">token</span> <span class="o">+</span>
</span><span class='line'>                 <span class="s">r&#39;|&#39;</span> <span class="o">+</span> <span class="n">quoted_string</span> <span class="o">+</span> <span class="s">r&#39;))&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="s">r&#39;^\s*(&#39;</span> <span class="o">+</span> <span class="n">token</span> <span class="o">+</span> <span class="s">r&#39;)/(&#39;</span> <span class="o">+</span> <span class="n">token</span> <span class="o">+</span>
</span><span class='line'>           <span class="s">r&#39;)(&#39;</span> <span class="o">+</span> <span class="n">extension</span> <span class="o">+</span> <span class="s">r&#39;*?\s*)$&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">acc_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headerval</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">headerval</span> <span class="o">=</span> <span class="n">headerval</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Accept类主要用来封装request的header，上面是一些属性变量和初始化方法。</li>
</ul>


<h3>_get_types</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="k">def</span> <span class="nf">_get_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">types</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">headerval</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">[]</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headerval</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
</span><span class='line'>            <span class="n">type_parms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acc_pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span> <span class="n">type_parms</span><span class="p">:</span>
</span><span class='line'>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Invalid accept header&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="n">typ</span><span class="p">,</span> <span class="n">subtype</span><span class="p">,</span> <span class="n">parms</span> <span class="o">=</span> <span class="n">type_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>            <span class="n">parms</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parms</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">seen_q_already</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>            <span class="n">quality</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">for</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
</span><span class='line'>                <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">parm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span class='line'>                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;q&#39;</span><span class="p">:</span>
</span><span class='line'>                    <span class="k">if</span> <span class="n">seen_q_already</span><span class="p">:</span>
</span><span class='line'>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Multiple &quot;q&quot; params&#39;</span><span class="p">)</span>
</span><span class='line'>                    <span class="n">seen_q_already</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>                    <span class="n">quality</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">pattern</span> <span class="o">=</span> <span class="s">&#39;^&#39;</span> <span class="o">+</span> \
</span><span class='line'>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span> <span class="k">else</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">typ</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> \
</span><span class='line'>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="k">if</span> <span class="n">subtype</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span> <span class="k">else</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">subtype</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39;$&#39;</span>
</span><span class='line'>            <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pattern</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span> <span class="s">&#39;*&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">subtype</span><span class="p">)))</span>
</span><span class='line'>        <span class="c"># sort candidates by quality, then whether or not there were globs</span>
</span><span class='line'>        <span class="n">types</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>如果header的值为空，则返回空的list。</li>
<li>将header的值按&#8217;,&lsquo;号分割并且遍历，再按acc的正则表达式去查找，如果没有返回ValueError。</li>
<li>如果查找到，将找到的第一个type_parms分为3个变量，parms变量再按&#8217;;&lsquo;号分割成1个list。</li>
<li>遍历params这个list，每个元素再按&#8217;=&lsquo;分割，分别取name和value，如果name等于&#8217;q&#8217;且seen_q_already为True，则抛异常，否则seen_q_already为True，quality为value的浮点数值。</li>
<li>拼装一个正则表达式给pattern赋值，types添加一个有pattern，quality和布尔值的元素。</li>
<li>最后将types按quality排序，最后返回每个之前拼装好的pattern列表。</li>
</ul>


<h3>best_match</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="k">def</span> <span class="nf">best_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
</span><span class='line'>        <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">        Returns the item from &quot;options&quot; that best matches the accept header.</span>
</span><span class='line'><span class="sd">        Returns None if no available options are acceptable to the client.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">        :param options: a list of content-types the server can respond with</span>
</span><span class='line'><span class="sd">        &quot;&quot;&quot;</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_types</span><span class="p">()</span>
</span><span class='line'>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="bp">None</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="n">types</span> <span class="ow">and</span> <span class="n">options</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
</span><span class='line'>                    <span class="k">return</span> <span class="n">option</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">None</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>先取types变量，types就是一个正则表达式的列表，如果取值的过程中抛异常则返回None。</li>
<li>如果types没有但options有，则返回options的第一个值。</li>
<li>如果types和options都有，则遍历types和options，如果option能在按正则表达式找到，则返回option，全部找不到返回None。</li>
</ul>


<h3>_req_environ_property</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">_req_environ_property</span><span class="p">(</span><span class="n">environ_field</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    Set and retrieve value of the environ_field entry in self.environ.</span>
</span><span class='line'><span class="sd">    (Used by both request and response)</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">getter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">environ_field</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">setter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">environ_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">environ_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">setter</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;Get and set the </span><span class="si">%s</span><span class="s"> property &quot;</span>
</span><span class='line'>                    <span class="s">&quot;in the WSGI environment&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">environ_field</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>封装了一对setter和getter方法，适用与request和respons。</li>
</ul>


<h3>_req_body_property</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">_req_body_property</span><span class="p">():</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    Set and retrieve the Request.body parameter.  It consumes wsgi.input and</span>
</span><span class='line'><span class="sd">    returns the results.  On assignment, uses a StringIO to create a new</span>
</span><span class='line'><span class="sd">    wsgi.input.</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">getter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.input&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">body</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">setter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;CONTENT_LENGTH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">setter</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s">&quot;Get and set the request body str&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>封装了一对setter和getter方法来处理request body。</li>
</ul>


<h3>_host_url_property</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">_host_url_property</span><span class="p">():</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    Retrieves the best guess that can be made for an absolute location up to</span>
</span><span class='line'><span class="sd">    the path, for example: https://host.com:1234</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">getter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="s">&#39;HTTP_HOST&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
</span><span class='line'>            <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;HTTP_HOST&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="n">host</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;SERVER_NAME&#39;</span><span class="p">],</span>
</span><span class='line'>                              <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;SERVER_PORT&#39;</span><span class="p">])</span>
</span><span class='line'>        <span class="n">scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wsgi.url_scheme&#39;</span><span class="p">,</span> <span class="s">&#39;http&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s">&#39;http&#39;</span> <span class="ow">and</span> <span class="n">host</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;:80&#39;</span><span class="p">):</span>
</span><span class='line'>            <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="k">elif</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s">&#39;https&#39;</span> <span class="ow">and</span> <span class="n">host</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;:443&#39;</span><span class="p">):</span>
</span><span class='line'>            <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">://</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s">&quot;Get url for request/response up to path&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>。</li>
</ul>

</div>

<div class="meta">
	
	
          | <a href="#comments">Comments</a>
    
</div>
</article>
	
		<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>

	
	
	
	  <section>
	    <h1>Comments</h1>
	    <div id="comments" aria-live="polite"><div class="ds-thread"></div>
<script type="text/javascript">
  var duoshuoQuery = {short_name:"zhaozhiming"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script></div>
	  </section>
	
</div>
	    </div>
	    <footer id="footer">
	    <div style="display:inline">
    Copyright &copy; 2014

    赵芝明
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


	    </footer>
	    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->





	</div>
	
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
