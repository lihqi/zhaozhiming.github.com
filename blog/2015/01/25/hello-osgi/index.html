
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>OSGi的简单代码示例 - Hacker and Geeker's Way</title>
    <meta name="author" content="赵芝明">
    
	<meta name="description" content="OSGI的简答代码示例">
	<meta name="keywords" content="osgi,felix">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Hacker and Geeker's Way" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='/stylesheets/slackey.css' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/fjalla_one.css' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/amethysta.css' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/css_grid.css' rel='stylesheet' type='text/css'>
	  <script src="https://cdn.staticfile.org/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    <link href="https://cdn.staticfile.org/semantic-ui/0.10.0/css/semantic.min.css" rel="stylesheet" type="text/css">

<script src="https://cdn.staticfile.org/semantic-ui/0.10.0/javascript/semantic.min.js"></script>
<script src="/javascripts/monthly_archive.js"></script>

    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-100485541-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
<div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        Hacker and Geeker's Way
    </div>
</h1>
<br>

<ul id="social-links" style="text-align:center">
  
  
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/zhaozhiming" class="github" title="Github"></a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/kingzzm" class="twitter" title="Twitter"></a>
  </li>
  
  
  <!-- LinkedIn -->
  <li>
  <a href="http://www.linkedin.com/in/zhaozhiming" class="linkedin" title="LinkedIn"></a>
  </li>
  
  
  
  
  
  <!-- Stackoverflow -->
  <li>
  <a href="http://stackoverflow.com/users//1954315/zhaozhiming" class="stackoverflow" title="Stackoverflow"></a>
  </li>
  
  
  <!-- wechat -->
  <li class="wechat">
  <a href="#" class="wechat" title="Wechat">
    <i class="wechat-qr"></i>
  </a>
  </li>
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

	<div id="toload">
		<div id="content">
			<div class="inner">
	<article class="post">
	<h2 class="title">OSGi的简单代码示例</h2>
	<div class="entry-content"><p><img src="/images/post/2015-1/osgi.gif"></p>

<p>OSGi(Open Service Gateway Initiative)是面向Java的动态模型系统，使用OSGi可以进行模块的动态加载，无需停止重启服务器，而模块就是我们下面要开发的Bundle。OSGi在电信或其他大型企业里面用的比较多，Eclipse现在也是用osgi的方式来添加插件。</p>

<!--more-->


<p></p>

<h2>IntelliJ IDEA的OSGi环境搭建</h2>

<ul>
<li>我们使用<a href="http://felix.apache.org/">Felix</a>这个OSGi框架来进行OSGi代码的开发，首先我们下载最新版本的Felix包并解压</li>
</ul>


<p><img src="/images/post/2015-1/felix_download.png"></p>

<ul>
<li>在IDEA进行OSGi的设置，选择刚才解压好的felix目录</li>
</ul>


<p><img src="/images/post/2015-1/felix_idea_setting_1.png"></p>

<p><img src="/images/post/2015-1/felix_idea_setting_2.png"></p>

<ul>
<li>写一个简单的Activator，下面要用到</li>
</ul>


<figure class='code'><figcaption><span>HelloActivator.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">zzm</span><span class="o">.</span><span class="na">osgi</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.osgi.framework.BundleActivator</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.osgi.framework.BundleContext</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloActivator</span> <span class="kd">implements</span> <span class="n">BundleActivator</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">bundleContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Hello World Bundle started!&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">bundleContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Hello World Bundle stop!&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>在工程设置页面进行设置，写上bundle对应的Activator</li>
</ul>


<p><img src="/images/post/2015-1/idea_project_setting_1.png"></p>

<p><img src="/images/post/2015-1/idea_project_setting_2.png"></p>

<p><img src="/images/post/2015-1/idea_project_setting_3.png"></p>

<ul>
<li>在Run菜单中添加osgi的运行配置，Run->Edit Configurations&hellip;</li>
</ul>


<p><img src="/images/post/2015-1/felix_idea_run_setting_1.png"></p>

<p><img src="/images/post/2015-1/felix_idea_run_setting_2.png"></p>

<p><img src="/images/post/2015-1/felix_idea_run_setting_3.png"></p>

<p><img src="/images/post/2015-1/felix_idea_run_setting_4.png"></p>

<p><img src="/images/post/2015-1/felix_idea_run_setting_5.png"></p>

<ul>
<li>运行felix</li>
</ul>


<p><img src="/images/post/2015-1/felix_idea_running_1.png"></p>

<p>可以看到IDEA已经帮我们自动启动了我们的Activator，打印了<code>Hello World Start</code>的语句。</p>

<p><img src="/images/post/2015-1/felix_idea_running_2.png"></p>

<p>输入<code>lb</code>查看所有bundle的信息，可以看到最下面是我们的bundle，已经激活。</p>

<p><img src="/images/post/2015-1/felix_idea_running_3.png"></p>

<p>我们停掉bundle，再显示所有bundle状态，可以看到我们的bundle的状态已经是<code>Resolved</code>了。</p>

<p><img src="/images/post/2015-1/felix_idea_running_4.png"></p>

<h2>使用felix的Maven Bundle插件来创建bundle</h2>

<p>上面是通过IDE来启动和创建bundle，我们再来看下使用felix maven插件的方式创建bundle，这里是官网地址说明: <a href="http://felix.apache.org/site/apache-felix-maven-bundle-plugin-bnd.html">http://felix.apache.org/site/apache-felix-maven-bundle-plugin-bnd.html</a>。</p>

<ul>
<li>首先新建Maven的pom.xml文件

<ul>
<li>在dependencies加入felix的jar包，最新的版本是1.4.0</li>
<li>在plugin中定义我们的bundle，包括我们的Activator等信息。</li>
<li>packaging需要修改为<code>bundle</code></li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span>pom.xml </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
</span><span class='line'>         <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span class='line'>         <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>com.zzm<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>osgi<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;packaging&gt;</span>bundle<span class="nt">&lt;/packaging&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;build&gt;</span>
</span><span class='line'>        <span class="nt">&lt;plugins&gt;</span>
</span><span class='line'>            <span class="nt">&lt;plugin&gt;</span>
</span><span class='line'>                <span class="nt">&lt;groupId&gt;</span>org.apache.felix<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>                <span class="nt">&lt;artifactId&gt;</span>maven-bundle-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>                <span class="nt">&lt;version&gt;</span>2.4.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>                <span class="nt">&lt;extensions&gt;</span>true<span class="nt">&lt;/extensions&gt;</span>
</span><span class='line'>
</span><span class='line'>                <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;instructions&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;Bundle-SymbolicName&gt;</span>${pom.groupId}.${pom.artifactId}<span class="nt">&lt;/Bundle-SymbolicName&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;Bundle-Vendor&gt;</span>Apache Felix<span class="nt">&lt;/Bundle-Vendor&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;Bundle-Activator&gt;</span>com.zzm.osgi.HelloActivator<span class="nt">&lt;/Bundle-Activator&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;Private-Package&gt;</span>com.zzm.osgi<span class="nt">&lt;/Private-Package&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;/instructions&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/plugin&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nt">&lt;/plugins&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/build&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;dependencies&gt;</span>
</span><span class='line'>        <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>            <span class="nt">&lt;groupId&gt;</span>org.apache.felix<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;artifactId&gt;</span>org.osgi.core<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;version&gt;</span>1.4.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependencies&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/project&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>还是使用我们之前的Activator，在工程根目录下使用maven进行打包，打包完后可以在target目录下面看到打好的bundle包。</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>mvn clean install
</span><span class='line'>...balabala
</span><span class='line'>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> --- maven-bundle-plugin:2.4.0:bundle <span class="o">(</span>default-bundle<span class="o">)</span> @ osgi ---
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> --- maven-install-plugin:2.5.2:install <span class="o">(</span>default-install<span class="o">)</span> @ osgi ---
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Installing /Users/zhaozhiming/projects/hello_osgi/bundles/osgi-1.0-SNAPSHOT.jar to /Users/zhaozhiming/.m2/repository/com/zzm/osgi/1.0-SNAPSHOT/osgi-1.0-SNAPSHOT.jar
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Installing /Users/zhaozhiming/projects/hello_osgi/pom.xml to /Users/zhaozhiming/.m2/repository/com/zzm/osgi/1.0-SNAPSHOT/osgi-1.0-SNAPSHOT.pom
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> --- maven-bundle-plugin:2.4.0:install <span class="o">(</span>default-install<span class="o">)</span> @ osgi ---
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Installing com/zzm/osgi/1.0-SNAPSHOT/osgi-1.0-SNAPSHOT.jar
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Writing OBR metadata
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> BUILD SUCCESS
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Total <span class="nb">time</span>: 3.898s
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Finished at: Sat Jan 31 10:44:49 HKT 2015
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Final Memory: 18M/216M
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>target
</span><span class='line'><span class="nv">$ </span>ls -l
</span><span class='line'>total 8
</span><span class='line'>drwxr-xr-x  4 zhaozhiming  staff   136 Jan 31 10:57 classes
</span><span class='line'>drwxr-xr-x  3 zhaozhiming  staff   102 Jan 31 10:57 maven-status
</span><span class='line'>-rw-r--r--  1 zhaozhiming  staff  2901 Jan 31 10:57 osgi-1.0-SNAPSHOT.jar
</span><span class='line'>drwxr-xr-x  4 zhaozhiming  staff   136 Jan 31 10:57 surefire-reports
</span><span class='line'>drwxr-xr-x  3 zhaozhiming  staff   102 Jan 31 10:57 <span class="nb">test</span>-classes
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>打完包后，在target/classes/META-INF目录下，可以看到maven会产生一个MANIFEST.MF文件，显示了bundle的具体信息。</li>
</ul>


<figure class='code'><figcaption><span>MANIFEST.MF </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>Manifest-Version: 1.0
</span><span class='line'>Bnd-LastModified: 1422673028905
</span><span class='line'>Build-Jdk: 1.8.0_25
</span><span class='line'>Built-By: zhaozhiming
</span><span class='line'>Bundle-Activator: com.zzm.osgi.HelloActivator
</span><span class='line'>Bundle-ManifestVersion: 2
</span><span class='line'>Bundle-Name: osgi
</span><span class='line'>Bundle-SymbolicName: com.zzm.osgi
</span><span class='line'>Bundle-Vendor: Apache Felix
</span><span class='line'>Bundle-Version: 1.0.0.SNAPSHOT
</span><span class='line'>Created-By: Apache Maven Bundle Plugin
</span><span class='line'>Export-Package: com.zzm.osgi;uses:<span class="o">=</span><span class="s2">&quot;org.osgi.framework&quot;</span>;<span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0.0.S</span>
</span><span class='line'><span class="s2"> NAPSHOT&quot;</span>
</span><span class='line'>Import-Package: org.osgi.framework;version<span class="o">=</span><span class="s2">&quot;[1.5,2)&quot;</span>
</span><span class='line'>Tool: Bnd-2.1.0.20130426-122213
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>在felix中运行bundle</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># 拷贝bundle包</span>
</span><span class='line'><span class="nv">$ </span>cp osgi-1.0-SNAPSHOT.jar /your/felix/parent/folder
</span><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /your/felix/parent/folder
</span><span class='line'><span class="nv">$ </span>ls
</span><span class='line'>drwxr-xr-x@ 12 zhaozhiming  staff   408 Jan 30 13:39 felix
</span><span class='line'>-rw-r--r--   1 zhaozhiming  staff  2901 Jan 31 11:18 osgi-1.0-SNAPSHOT.jar
</span><span class='line'>
</span><span class='line'><span class="c"># 启动felix</span>
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>felix
</span><span class='line'><span class="nv">$ </span>java -jar bin/felix.jar
</span><span class='line'>____________________________
</span><span class='line'>Welcome to Apache Felix Gogo
</span><span class='line'>
</span><span class='line'>g!
</span><span class='line'>
</span><span class='line'><span class="c"># 查看所有bundle</span>
</span><span class='line'>g! lb
</span><span class='line'>START LEVEL 1
</span><span class='line'>   ID|State      |Level|Name
</span><span class='line'>    0|Active     |    0|System Bundle <span class="o">(</span>4.6.0<span class="o">)</span>
</span><span class='line'>    1|Active     |    1|Apache Felix Bundle Repository <span class="o">(</span>2.0.2<span class="o">)</span>
</span><span class='line'>    2|Active     |    1|Apache Felix Gogo Command <span class="o">(</span>0.14.0<span class="o">)</span>
</span><span class='line'>    3|Active     |    1|Apache Felix Gogo Runtime <span class="o">(</span>0.12.1<span class="o">)</span>
</span><span class='line'>    4|Active     |    1|Apache Felix Gogo Shell <span class="o">(</span>0.10.0<span class="o">)</span>
</span><span class='line'>    5|Active     |    1|Sample01 <span class="o">(</span>1.0.0.SNAPSHOT<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># 安装我们的bundle</span>
</span><span class='line'>g! install file:../osgi-1.0-SNAPSHOT.jar
</span><span class='line'>Bundle ID: 253
</span><span class='line'>
</span><span class='line'><span class="c"># 查看bundle信息</span>
</span><span class='line'>g! lb
</span><span class='line'>START LEVEL 1
</span><span class='line'>   ID|State      |Level|Name
</span><span class='line'>   ...
</span><span class='line'>  253|Installed  |    1|osgi <span class="o">(</span>1.0.0.SNAPSHOT<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># 启动我们的bundle</span>
</span><span class='line'>g! start 253
</span><span class='line'>Hello World Bundle start!
</span><span class='line'>g! lb
</span><span class='line'>START LEVEL 1
</span><span class='line'>   ID|State      |Level|Name
</span><span class='line'>    ...
</span><span class='line'>  253|Active     |    1|osgi <span class="o">(</span>1.0.0.SNAPSHOT<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># 停掉我们的bundle</span>
</span><span class='line'>g! stop 253
</span><span class='line'>Hello World Bundle stop!
</span><span class='line'>g! lb
</span><span class='line'>START LEVEL 1
</span><span class='line'>   ID|State      |Level|Name
</span><span class='line'>   ...
</span><span class='line'>  253|Resolved   |    1|osgi <span class="o">(</span>1.0.0.SNAPSHOT<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># 卸载我们的bundle，可以看到已经没有出现在所有bundle信息中了</span>
</span><span class='line'>g! uninstall 253
</span><span class='line'>g! lb
</span><span class='line'>START LEVEL 1
</span><span class='line'>   ID|State      |Level|Name
</span><span class='line'>    0|Active     |    0|System Bundle <span class="o">(</span>4.6.0<span class="o">)</span>
</span><span class='line'>    1|Active     |    1|Apache Felix Bundle Repository <span class="o">(</span>2.0.2<span class="o">)</span>
</span><span class='line'>    2|Active     |    1|Apache Felix Gogo Command <span class="o">(</span>0.14.0<span class="o">)</span>
</span><span class='line'>    3|Active     |    1|Apache Felix Gogo Runtime <span class="o">(</span>0.12.1<span class="o">)</span>
</span><span class='line'>    4|Active     |    1|Apache Felix Gogo Shell <span class="o">(</span>0.10.0<span class="o">)</span>
</span><span class='line'>    5|Active     |    1|Sample01 <span class="o">(</span>1.0.0.SNAPSHOT<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># 最后`ctl+c`退出felix</span>
</span></code></pre></td></tr></table></div></figure>


<h2>在bundle中添加第三方包</h2>

<p>在bundle中使用第三方包比较麻烦，查看了各方资料，只找到了把第三方jar包一起打进bundle的方法，我们以引入<a href="https://code.google.com/p/guava-libraries/"><code>guava</code></a>包为例，下面代码加注释的就是修改的地方。</p>

<figure class='code'><figcaption><span>pom.xml </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
</span><span class='line'>         <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span class='line'>         <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>com.zzm<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>osgi<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;packaging&gt;</span>bundle<span class="nt">&lt;/packaging&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;build&gt;</span>
</span><span class='line'>        <span class="nt">&lt;plugins&gt;</span>
</span><span class='line'>            <span class="nt">&lt;plugin&gt;</span>
</span><span class='line'>                <span class="nt">&lt;groupId&gt;</span>org.apache.felix<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>                <span class="nt">&lt;artifactId&gt;</span>maven-bundle-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>                <span class="nt">&lt;version&gt;</span>2.4.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>                <span class="nt">&lt;extensions&gt;</span>true<span class="nt">&lt;/extensions&gt;</span>
</span><span class='line'>
</span><span class='line'>                <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>                <span class="c">&lt;!--修改bundle配置  --&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;instructions&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;Bundle-SymbolicName&gt;</span>${pom.groupId}.${pom.artifactId}<span class="nt">&lt;/Bundle-SymbolicName&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;Bundle-Vendor&gt;</span>Apache Felix<span class="nt">&lt;/Bundle-Vendor&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;Bundle-Activator&gt;</span>com.zzm.osgi.HelloActivator<span class="nt">&lt;/Bundle-Activator&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;Private-Package&gt;</span>com.zzm.osgi<span class="nt">&lt;/Private-Package&gt;</span>
</span><span class='line'>
</span><span class='line'>                        <span class="nt">&lt;Embed-Dependency&gt;</span>
</span><span class='line'>                            *;scope=compile|runtime;inline=false
</span><span class='line'>                        <span class="nt">&lt;/Embed-Dependency&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;_exportcontents&gt;</span>*<span class="nt">&lt;/_exportcontents&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;Bundle-ClassPath&gt;</span>.,{maven-dependencies}<span class="nt">&lt;/Bundle-ClassPath&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;Embed-Transitive&gt;</span>true<span class="nt">&lt;/Embed-Transitive&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;Embed-Directory&gt;</span>jars<span class="nt">&lt;/Embed-Directory&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;Embed-StripGroup&gt;</span>true<span class="nt">&lt;/Embed-StripGroup&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;_failok&gt;</span>true<span class="nt">&lt;/_failok&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;_nouses&gt;</span>true<span class="nt">&lt;/_nouses&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;/instructions&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/plugin&gt;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c">&lt;!-- 添加依赖包copy插件 --&gt;</span>
</span><span class='line'>            <span class="nt">&lt;plugin&gt;</span>
</span><span class='line'>                <span class="nt">&lt;artifactId&gt;</span>maven-dependency-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>                <span class="nt">&lt;executions&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;execution&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;id&gt;</span>copy-dependencies<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;goals&gt;</span>
</span><span class='line'>                            <span class="nt">&lt;goal&gt;</span>copy-dependencies<span class="nt">&lt;/goal&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;/goals&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>                            <span class="nt">&lt;outputDirectory&gt;</span>jars<span class="nt">&lt;/outputDirectory&gt;</span>
</span><span class='line'>                        <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;/execution&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/executions&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/plugin&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/plugins&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/build&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;dependencies&gt;</span>
</span><span class='line'>        <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>            <span class="nt">&lt;groupId&gt;</span>org.apache.felix<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;artifactId&gt;</span>org.osgi.core<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;version&gt;</span>1.4.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c">&lt;!-- 在pom中添加guava依赖 --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>            <span class="nt">&lt;groupId&gt;</span>com.google.guava<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;artifactId&gt;</span>guava<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>            <span class="nt">&lt;version&gt;</span>18.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependencies&gt;</span>
</span><span class='line'><span class="nt">&lt;/project&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>在Activator中添加guava的代码</li>
</ul>


<figure class='code'><figcaption><span>HelloActivator.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloActivator</span> <span class="kd">implements</span> <span class="n">BundleActivator</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">bundleContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Hello World Bundle start!&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">strings</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">(</span><span class="s">&quot;I&quot;</span><span class="o">,</span> <span class="s">&quot;use&quot;</span><span class="o">,</span> <span class="s">&quot;guava&quot;</span><span class="o">,</span> <span class="s">&quot;here&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">strings</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>打包运行我们的bundle</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>mvn clean install
</span><span class='line'><span class="nv">$ </span>cp osgi-1.0-SNAPSHOT.jar /your/felix/parent/folder
</span><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /your/felix/parent/folder
</span><span class='line'><span class="nv">$ </span>java -jar bin/felix.jar
</span><span class='line'>____________________________
</span><span class='line'>Welcome to Apache Felix Gogo
</span><span class='line'>
</span><span class='line'>g! install file:../osgi-1.0-SNAPSHOT.jar
</span><span class='line'>Bundle ID: 258
</span><span class='line'>g! start 258
</span><span class='line'>Hello World Bundle start!
</span><span class='line'><span class="o">[</span>I, use, guava, here<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>可以解压我们的bundle jar包看一下结构</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>mkdir jar_tar
</span><span class='line'><span class="nv">$ </span>cp osgi-1.0-SNAPSHOT.jar jar_tar/
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>jar_tar/
</span><span class='line'><span class="nv">$ </span>tar -xvf osgi-1.0-SNAPSHOT.jar
</span><span class='line'><span class="nv">$ </span>ls -l <span class="c"># 可以看到有个jars的文件夹</span>
</span><span class='line'>drwxr-xr-x  4 zhaozhiming  staff      136 Jan 31 11:56 META-INF
</span><span class='line'>drwxr-xr-x  3 zhaozhiming  staff      102 Jan 31 11:44 com
</span><span class='line'>drwxr-xr-x  3 zhaozhiming  staff      102 Jan 31 11:44 jars
</span><span class='line'>-rw-r--r--  1 zhaozhiming  staff  1998876 Jan 31 11:55 osgi-1.0-SNAPSHOT.jar
</span><span class='line'><span class="nv">$ </span>ls -l jars <span class="c"># jars里面是我们的第三方包</span>
</span><span class='line'>-rwxr-xr-x  1 zhaozhiming  staff  2256213 Jan 30 10:07 guava-18.0.jar
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>再看一下MANIFEST.MF文件，如下所示。</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>Manifest-Version: 1.0
</span><span class='line'>Bnd-LastModified: 1422675843327
</span><span class='line'>Build-Jdk: 1.8.0_25
</span><span class='line'>Built-By: zhaozhiming
</span><span class='line'>Bundle-Activator: com.zzm.osgi.HelloActivator
</span><span class='line'>Bundle-ClassPath: .,jars/guava-18.0.jar
</span><span class='line'>Bundle-ManifestVersion: 2
</span><span class='line'>Bundle-Name: osgi
</span><span class='line'>Bundle-SymbolicName: com.zzm.osgi
</span><span class='line'>Bundle-Vendor: Apache Felix
</span><span class='line'>Bundle-Version: 1.0.0.SNAPSHOT
</span><span class='line'>Created-By: Apache Maven Bundle Plugin
</span><span class='line'>Embed-Dependency: *;scope<span class="o">=</span>compile|runtime;inline<span class="o">=</span><span class="nb">false</span>
</span><span class='line'>Embed-Directory: jars
</span><span class='line'>Embed-StripGroup: <span class="nb">true</span>
</span><span class='line'>Embed-Transitive: <span class="nb">true</span>
</span><span class='line'>Embedded-Artifacts: jars/guava-18.0.jar;g<span class="o">=</span><span class="s2">&quot;com.google.guava&quot;</span>;<span class="nv">a</span><span class="o">=</span><span class="s2">&quot;guava&quot;</span>;<span class="nv">v</span>
</span><span class='line'> <span class="o">=</span><span class="s2">&quot;18.0&quot;</span>
</span><span class='line'>Export-Package: com.google.common.annotations;version<span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>,com.googl
</span><span class='line'> e.common.base;version<span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>,com.google.common.base.internal;version<span class="o">=</span>
</span><span class='line'> <span class="s2">&quot;1.0.0.SNAPSHOT&quot;</span>,com.google.common.cache;version<span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>,com.google.co
</span><span class='line'> mmon.collect;version<span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>,com.google.common.escape;version<span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>
</span><span class='line'> ,com.google.common.eventbus;version<span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>,com.google.common.hash;ver
</span><span class='line'> <span class="nv">sion</span><span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>,com.google.common.html;version<span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>,com.google.common
</span><span class='line'> .io;version<span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>,com.google.common.math;version<span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>,com.google
</span><span class='line'> .common.net;version<span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>,com.google.common.primitives;version<span class="o">=</span><span class="s2">&quot;18.0</span>
</span><span class='line'><span class="s2"> .0&quot;</span>,com.google.common.reflect;version<span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>,com.google.common.util.c
</span><span class='line'> oncurrent;version<span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>,com.google.common.xml;version<span class="o">=</span><span class="s2">&quot;18.0.0&quot;</span>,com.g
</span><span class='line'> oogle.thirdparty.publicsuffix;version<span class="o">=</span><span class="s2">&quot;1.0.0.SNAPSHOT&quot;</span>,com.zzm.osgi;ver
</span><span class='line'> <span class="nv">sion</span><span class="o">=</span><span class="s2">&quot;1.0.0.SNAPSHOT&quot;</span>,jars;version<span class="o">=</span><span class="s2">&quot;1.0.0.SNAPSHOT&quot;</span>
</span><span class='line'>Import-Package: javax.annotation,org.osgi.framework;version<span class="o">=</span><span class="s2">&quot;[1.5,2)&quot;</span>,su
</span><span class='line'> n.misc
</span><span class='line'>Tool: Bnd-2.1.0.20130426-122213
</span></code></pre></td></tr></table></div></figure>


<p><code>PS</code>:在Import-Package中有sun.misc的字样，表示bundle引入了jdk的一些包，有时候在运行bundle的时候会看到下面的错误:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>org.osgi.framework.BundleException: Unresolved constraint in bundle <span class="o">[</span>8<span class="o">]</span>: Unable to resolve 8.0: missing requirement <span class="o">[</span>8.0<span class="o">]</span> osgi.wiring.package; <span class="o">(</span>osgi.wiring.package<span class="o">=</span>sun.misc<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>解决办法有2个，执行解决办法意味着你清楚并明确运行bundle时可以缺少这些包:</p>

<p>way1:是在pom文件中的&lt;Import-Package>中加入!sum.misc，这样打出来的MANIFEST.MF的Import-Package就不会有sun.misc字样了。</p>

<figure class='code'><figcaption><span>pom.xml </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>  <span class="nt">&lt;Bundle-SymbolicName&gt;</span>${project.groupId}.${project.artifactId}<span class="nt">&lt;/Bundle-SymbolicName&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Bundle-Vendor&gt;</span>joyotime<span class="nt">&lt;/Bundle-Vendor&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Bundle-Version&gt;</span>${project.version}<span class="nt">&lt;/Bundle-Version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Bundle-Activator&gt;</span>com.morewifi.chinatelecom.MoreWifiActivator<span class="nt">&lt;/Bundle-Activator&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Private-Package&gt;</span>com.morewifi.chinatelecom<span class="nt">&lt;/Private-Package&gt;</span>
</span><span class='line'>    ...
</span><span class='line'>    <span class="nt">&lt;Import-Package&gt;</span>
</span><span class='line'>        !sun.misc,*
</span><span class='line'>    <span class="nt">&lt;/Import-Package&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>way2:在felix解压包下有个conf/config.properties文件，在里面配置缺少的包。</p>

<figure class='code'><figcaption><span>felix/conf/config.properties </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="na">org.osgi.framework.system.packages.extra</span><span class="o">=</span><span class="s">sun.misc</span>
</span></code></pre></td></tr></table></div></figure>


<h2>在bundle中保存文件</h2>

<p>有时候在bundle中需要写一些数据到文件保存起来，可以使用<code>bundleContext</code>的<code>getDataFile</code>方法来获取文件，下面代码使用了guava的io方法。</p>

<figure class='code'><figcaption><span>HelloActivator.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloActivator</span> <span class="kd">implements</span> <span class="n">BundleActivator</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">BundleContext</span> <span class="n">bundleContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Hello World Bundle start!&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">strings</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">(</span><span class="s">&quot;I&quot;</span><span class="o">,</span> <span class="s">&quot;use&quot;</span><span class="o">,</span> <span class="s">&quot;guava&quot;</span><span class="o">,</span> <span class="s">&quot;here&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">strings</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//保存文件</span>
</span><span class='line'>        <span class="n">File</span> <span class="n">dataFile</span> <span class="o">=</span> <span class="n">bundleContext</span><span class="o">.</span><span class="na">getDataFile</span><span class="o">(</span><span class="s">&quot;save.txt&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Files</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">strings</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">dataFile</span><span class="o">,</span> <span class="n">Charsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 读取文件</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">fileContent</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readFirstLine</span><span class="o">(</span><span class="n">dataFile</span><span class="o">,</span> <span class="n">Charsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fileContent</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>打印结果如下:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>g! start 263
</span><span class='line'>Hello World Bundle start!
</span><span class='line'><span class="o">[</span>I, use, guava, here<span class="o">]</span>
</span><span class='line'><span class="o">[</span>I, use, guava, here<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>在felix的目录下，有个felix-cache目录，下面是各个bundle对应的文件夹，我们的save.txt就存放在bundle的data文件夹里面。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">cd </span>felix-cache/bundle263/
</span><span class='line'><span class="nv">$ </span>ls -l
</span><span class='line'>-rw-r--r--  1 zhaozhiming  staff   54 Jan 31 13:51 bundle.info
</span><span class='line'>drwxr-xr-x  3 zhaozhiming  staff  102 Jan 31 13:50 data
</span><span class='line'>drwxr-xr-x  5 zhaozhiming  staff  170 Jan 31 13:50 version0.0
</span><span class='line'><span class="nv">$ </span>ls -l data
</span><span class='line'>-rw-r--r--  1 zhaozhiming  staff  21 Jan 31 13:50 save.txt
</span><span class='line'><span class="nv">$ </span>cat data/save.txt
</span><span class='line'><span class="o">[</span>I, use, guava, here<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>



</div>

<div class="meta">
</div>
</article>
  <section id="appreciates">
    <center>
	    <h2>赞赏</h2>
	    <h4>如果文章对您有所帮助，可以转点 ETH 给我喝咖啡😌，钱包二维码：</h4>
      <span>0x0C9b27c89A61aadb0aEC24CA8949910Cbf77Aa73</span>
      <img src="/images/my_eth_qrcode.png" alt="qrcode" width="250" >
    </center>
  </section>
	
		<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>

	
	
	<section id="comment">
	    <h2 class="title">Comments</h2>
	    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
	</section>
	
</div>

	    </div>
	    <footer id="footer">
	    <div style="display:inline">
    Copyright &copy; 2018

    赵芝明
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


	    </footer>
	    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'zhaozhiming';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://zhaozhiming.github.io/blog/2015/01/25/hello-osgi/';
        var disqus_url = 'http://zhaozhiming.github.io/blog/2015/01/25/hello-osgi/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>




	</div>
	
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
