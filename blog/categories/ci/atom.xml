<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: CI | Hacker and Geeker's Way]]></title>
  <link href="http://zhaozhiming.github.io/blog/categories/ci/atom.xml" rel="self"/>
  <link href="http://zhaozhiming.github.io/"/>
  <updated>2016-03-29T22:13:27+08:00</updated>
  <id>http://zhaozhiming.github.io/</id>
  <author>
    <name><![CDATA[赵芝明]]></name>
    <email><![CDATA[kingzzm1982@sina.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[gitlab CI runner的创建和配置]]></title>
    <link href="http://zhaozhiming.github.io/blog/2015/11/30/gitlab-ci-runner-create-and-config/"/>
    <updated>2015-11-30T22:13:00+08:00</updated>
    <id>http://zhaozhiming.github.io/blog/2015/11/30/gitlab-ci-runner-create-and-config</id>
    <content type="html"><![CDATA[<p><img src="/images/post/2015-11/gitlab-ci-runner.png" width="400" height="350"></p>

<p><a href="https://gitlab.com/">gitlab</a>不仅是一个代码托管的开源框架，同时它还集成了CI的功能，可以方便地为gitlab上的项目添加CI功能。</p>

<!--more-->


<p></p>

<h2>创建Runner</h2>

<ul>
<li>Runner服务器</li>
</ul>


<p>首先要找一台服务器来创建Runner，因为是要跟你的gitlab服务关联，所以服务器要可以访问你的gitlab服务。</p>

<ul>
<li>安装gitlab-CI-multi-runner</li>
</ul>


<p>gitlab-ci-multi-runner是CI runner的运行程序，这里有多种安装方式（<a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner#installation/">见这里</a>），这里我们使用了第一种：在linux中安装软件。</p>

<h2>gitlab-ci-multi-runner命令介绍</h2>

<p>执行<code>gitlab-ci-multi-runner help</code>可以看到所有命令的简介，在每个命令加<code>--help</code>可以看到更加具体的参数，比如<code>gitlab-ci-multi-runner start --help</code>，命令的执行顺序为：<code>register(注册runner)--&gt;install(安装服务)--&gt;start(运行服务)</code>。</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>COMMANDS:
</span><span class='line'>   run          run multi runner service
</span><span class='line'>   register     register a new runner
</span><span class='line'>   install      install service
</span><span class='line'>   uninstall    uninstall service
</span><span class='line'>   start        start service
</span><span class='line'>   stop         stop service
</span><span class='line'>   restart      restart service
</span><span class='line'>   run-single   start single runner
</span><span class='line'>   unregister   unregister specific runner
</span><span class='line'>   verify       verify all registered runners
</span><span class='line'>   <span class="nb">help</span>, h      Shows a list of commands or <span class="nb">help </span><span class="k">for </span>one <span class="nb">command</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;GLOBAL OPTIONS:
</span><span class='line'>   &amp;mdash;debug                      debug mode <span class="o">[</span><span class="nv">$DEBUG</span><span class="o">]</span>
</span><span class='line'>   &amp;mdash;log-level, -l &amp;ldquo;info&amp;rdquo;       Log level <span class="o">(</span>options: debug, info, warn, error, fatal, panic<span class="o">)</span>
</span><span class='line'>   &amp;mdash;help, -h                   show <span class="nb">help</span>
</span><span class='line'>   &amp;mdash;version, -v                print the version
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>gitlab CI配置</h2>

<ul>
<li>打开网址（比如你的gitlab服务地址是：<code>http://gitlab.your.company/</code>，那gitlab CI的地址就是：<code>http://gitlab.your.company/ci</code>），找到想要配置CI的项目，点击后面的按钮<code>Add project to CI</code>，给项目配置CI功能。</li>
<li>进入CI项目，进入<code>Runners</code>标签页面，可以看到CI的url和token，这2个值是待会用命令注册runner时所需要的。</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>How to setup a new project specific runner
</span><span class='line'>Install GitLab Runner software. Checkout the GitLab Runner section to install it
</span><span class='line'>Specify following URL during runner setup:
</span><span class='line'>&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://gitlab.your.company/ci&quot;</span>&gt;http://gitlab.your.company/ci&lt;/a&gt;
</span><span class='line'>Use the following registration token during setup:
</span><span class='line'>7c92da80317b5f5e1fe1c62a1b0767
</span><span class='line'>Start runner!
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>在runner的服务器上注册runner，执行命令<code>gitlab-ci-multi-runner register</code>，下面是执行命令后的交互信息。<br/>
<code>PS：如果你用的是docker的执行方式，可以先把对应的docker的image下载下来，不然第一次执行CI会比较慢。</code></li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>root@cloudeye:~# gitlab-ci-multi-runner register
</span><span class='line'>Please enter the gitlab-ci coordinator URL <span class="o">(</span>e.g. &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;https://gitlab.com/ci&quot;</span>&gt;https://gitlab.com/ci&lt;/a&gt;<span class="o">)</span>: <span class="c">## 输入你CI服务器的地址</span>
</span><span class='line'>&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://gitlab.your.company/ci&quot;</span>&gt;http://gitlab.your.company/ci&lt;/a&gt;
</span><span class='line'>Please enter the gitlab-ci token <span class="k">for </span>this runner: <span class="c">## 输入你CI项目的token</span>
</span><span class='line'>7c92da80317b5f5e1fe1c62a1b0767
</span><span class='line'>Please enter the gitlab-ci description <span class="k">for </span>this runner: <span class="c">## 描述信息，只是表述不是很重要</span>
</span><span class='line'>Please enter the gitlab-ci tags <span class="k">for </span>this runner <span class="o">(</span>comma separated<span class="o">)</span>: <span class="c">## runner的标签</span>
</span><span class='line'>dev
</span><span class='line'>INFO<span class="o">[</span>0032<span class="o">]</span> fc6e1ee6 Registering runner&amp;hellip; succeeded
</span><span class='line'>Please enter the executor: docker-ssh, ssh, shell, parallels, docker: <span class="c">## runner的执行方式，有5种，这里我选择了docker</span>
</span><span class='line'>docker
</span><span class='line'>Please enter the Docker image <span class="o">(</span>eg. ruby:2.1<span class="o">)</span>: <span class="c">## docker镜像</span>
</span><span class='line'>node:0.12.7
</span><span class='line'>If you want to <span class="nb">enable </span>mysql please enter version <span class="o">(</span>X.Y<span class="o">)</span> or enter latest? <span class="c">## 不需要的话直接空格就可以了&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'>&lt;p&gt;If you want to <span class="nb">enable </span>postgres please enter version <span class="o">(</span>X.Y<span class="o">)</span> or enter latest? <span class="c">## 不需要的话直接空格就可以了&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'>&lt;p&gt;If you want to <span class="nb">enable </span>redis please enter version <span class="o">(</span>X.Y<span class="o">)</span> or enter latest? <span class="c">## 不需要的话直接空格就可以了&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'>&lt;p&gt;If you want to <span class="nb">enable </span>mongo please enter version <span class="o">(</span>X.Y<span class="o">)</span> or enter latest? <span class="c">## 不需要的话直接空格就可以了&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'>&lt;p&gt;INFO<span class="o">[</span>0043<span class="o">]</span> Runner registered successfully. Feel free to start it, but <span class="k">if </span>it&amp;rsquo;s running already the config should be automatically reloaded!
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>注册完成后，打开runner的配置文件：<code>vi /etc/gitlab-runner/config.toml</code>，可以看到配置文件里面增加了刚才注册的相关信息，更多参数的信息可以看<a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/configuration/advanced-configuration.md">官方文档</a>。</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>root@cloudeye:~# gitlab-ci-multi-runner register
</span><span class='line'><span class="nv">concurrent</span> <span class="o">=</span> 2&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="o">[[</span>runners<span class="o">]]</span>
</span><span class='line'>  <span class="nv">url</span> <span class="o">=</span> &amp;ldquo;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://gitlab.your.company/ci&quot;</span>&gt;http://gitlab.your.company/ci&lt;/a&gt;&amp;rdquo;
</span><span class='line'>  <span class="nv">token</span> <span class="o">=</span> &amp;ldquo;79bf814ac37a52427345b01e135a78&amp;rdquo;
</span><span class='line'>  <span class="nv">name</span> <span class="o">=</span> &amp;ldquo;your-project&amp;rdquo;
</span><span class='line'>  <span class="nv">executor</span> <span class="o">=</span> &amp;ldquo;docker&amp;rdquo;
</span><span class='line'>  <span class="o">[</span>runners.docker<span class="o">]</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;image <span class="o">=</span> <span class="s2">&quot;node:0.12.7&quot;</span>
</span><span class='line'><span class="nv">privileged</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'><span class="nv">disable_cache</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nv">volumes</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;/cache:/cache:rw&quot;</span><span class="o">]</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>安装服务，执行命令<code>gitlab-ci-multi-runner install -n "服务名"</code>，后面的服务名是自己定义的名称，用来后面启动命名使用，与其相对的命令是<code>uninstall</code>。</li>
<li>启动服务，执行命令<code>gitlab-ci-multi-runner start -n "服务名"</code>，与其相类似的命令有<code>stop</code>和<code>restart</code>。</li>
<li>验证runner，执行<code>gitlab-ci-multi-runner verify</code>，可以看到runner的运行情况。</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>root@cloudeye:~# gitlab-ci-multi-runner verify
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> 79bf814a Veryfing runner&amp;hellip; is alive
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> 207a4b34 Veryfing runner&amp;hellip; is alive
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> 20f849f7 Veryfing runner&amp;hellip; is alive
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> 6e07e13a Veryfing runner&amp;hellip; is alive
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> 23be6deb Veryfing runner&amp;hellip; is alive
</span><span class='line'>INFO<span class="o">[</span>0000<span class="o">]</span> 4e348964 Veryfing runner&amp;hellip; is alive
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>启动服务后，可以在刚才的CI runners页面看到已经有runner出现了。</li>
</ul>


<h2>gitlab-ci.yaml文件</h2>

<p>配置好了runner，要让CI跑起来，还需要在项目根目录放一个<code>.gitlab-ci.yaml</code>文件，在这个文件里面可以定制CI的任务，下面是简单的示例文件，更多的用法可以看<a href="http://doc.gitlab.com/ci/yaml/README.html">官方文档</a>。</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">efore_script</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="nl">&amp;ndash</span><span class="l-Scalar-Plain">; bundle_install</span>
</span><span class='line'><span class="l-Scalar-Plain">job1</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script:&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;pre&gt;&lt;code&gt;- execute-script-for-job1</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>
]]></content>
  </entry>
  
</feed>
